<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <!-- Site Meta Data -->
  <title>01. Windows 搭建下 Lua 开发环境</title>
  <meta name="description" content="">
  <meta name="author" content="martin">

  <!-- Style Meta Data -->
  <link rel="stylesheet" href="http://blog.smallcpp.cn/theme/css/notebook.css" type="text/css" />
  <link rel="shortcut icon" href="http://blog.smallcpp.cn/theme/images/avatar.png">

  <!-- Feed Meta Data -->
  <link href="http://blog.smallcpp.cn/" type="application/atom+xml" rel="alternate" title="Small Cpp ATOM Feed" />

  <!-- Twitter Feed -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="">
  <meta name="twitter:image" content="http://blog.smallcpp.cn/theme/images/avatar.png">

<meta name="twitter:creator" content="">
<meta name="twitter:url" content="http://blog.smallcpp.cn/01-windows-da-jian-xia-lua-kai-fa-huan-jing.html">
<meta name="twitter:title" content="Small Cpp ~ 01. Windows 搭建下 Lua 开发环境">
<meta name="twitter:description" content="Windows 搭建 Lua 环境包含3部分内容：编译lua的库文件(*.lib)、编译lua解释器(lua.exe)、编译lua编译器(luac.exe). 我们采用 VS2013 + lua-5.2.4 来进行编译. VS2013 就不说了, 先去 Lua 官网下载 Lua 源码: http://www.lua.org 我这里下载的是 …">

<!-- Facebook Meta Data -->
<meta property="og:title" content="Small Cpp ~ 01. Windows 搭建下 Lua 开发环境" />
<meta property="og:description" content="Windows 搭建 Lua 环境包含3部分内容：编译lua的库文件(*.lib)、编译lua解释器(lua.exe)、编译lua编译器(luac.exe). 我们采用 VS2013 + lua-5.2.4 来进行编译. VS2013 就不说了, 先去 Lua 官网下载 Lua 源码: http://www.lua.org 我这里下载的是 …" />
<meta property="og:image" content="theme/images/avatar.png" />
</head>

<body>
  <!-- Sidebar -->
  <aside>
    <p><a href="http://blog.smallcpp.cn"><img id="avatar" src="http://blog.smallcpp.cn/theme/images/avatar.png"></a></p>
    <h1>Small Cpp</h1>
    <p>勿在浮沙筑高台, 练从难处练, 用从易处用.</p>
    <hr>
    <h2>Social</h2>
    <ul class="social">
      <a href="http://blog.csdn.net/u010850265">CSDN</a></li>
    </ul>
    <h2>Categories</h2>
    <ul class="navbar">
      <li><a href="http://blog.smallcpp.cn/category/c11.html">C++11</a></li>
      <li><a href="http://blog.smallcpp.cn/category/da-shu-ju.html">大数据</a></li>
      <li><a href="http://blog.smallcpp.cn/category/du-shu-bi-ji.html">读书笔记</a></li>
      <li><a href="http://blog.smallcpp.cn/category/golang.html">Golang</a></li>
      <li><a href="http://blog.smallcpp.cn/category/hei-ke-ji.html">黑科技</a></li>
      <li><a href="http://blog.smallcpp.cn/category/java.html">Java</a></li>
      <li><a href="http://blog.smallcpp.cn/category/linux.html">Linux</a></li>
      <li class="active"><a href="http://blog.smallcpp.cn/category/lua.html">Lua</a></li>
      <li><a href="http://blog.smallcpp.cn/category/mongodb.html">Mongodb</a></li>
      <li><a href="http://blog.smallcpp.cn/category/pyqt.html">PyQt</a></li>
      <li><a href="http://blog.smallcpp.cn/category/python.html">Python</a></li>
      <li><a href="http://blog.smallcpp.cn/category/qt.html">QT</a></li>
      <li><a href="http://blog.smallcpp.cn/category/qu-kuai-lian.html">区块链</a></li>
      <li><a href="http://blog.smallcpp.cn/category/redis.html">Redis</a></li>
      <li><a href="http://blog.smallcpp.cn/category/ruan-jian-she-ji.html">软件设计</a></li>
      <li><a href="http://blog.smallcpp.cn/category/za-xiang.html">杂项</a></li>
    </ul> 
  </aside>

  <!-- Content -->
  <article>
<section id="content">
    <article>
        <header class="post_list">
            <h2 class="post_title"><a href="http://blog.smallcpp.cn/01-windows-da-jian-xia-lua-kai-fa-huan-jing.html" rel="bookmark" title="Permalink to 01. Windows 搭建下 Lua 开发环境">01. Windows 搭建下 Lua 开发环境</a></h2>
            <span>Par </span>
            <a href="http://blog.smallcpp.cn/author/martin.html">@Martin</a>
            <span> dans </span>
            <span class="post_category"><a href="http://blog.smallcpp.cn/category/lua.html" rel="bookmark" title="Permalink to Lua">[ Lua ]</a></span>
            <span> le </span>
            <span class="post_date">Sat 14 March 2015</span>
            <div></div>
            <div><span>Tags : </span>
            </div>
        </header>
        <div class="entry-content">
            <p>Windows 搭建 Lua 环境包含3部分内容：<strong>编译lua的库文件(*.lib)、编译lua解释器(lua.exe)、编译lua编译器(luac.exe)</strong>.
我们采用 VS2013 + lua-5.2.4 来进行编译.</p>
<p>VS2013 就不说了, 先去 Lua 官网下载 Lua 源码: <a href="http://www.lua.org">http://www.lua.org</a><br>
我这里下载的是 lua-5.2.4 版本.</p>
<p><img alt="" src="http://i62.tinypic.com/1z1bmoo.jpg"></p>
<p>下载后解压, 我们得到以下文件, 其中 <strong>src</strong> 文件夹存放的就是 Lua 源码.</p>
<p><img alt="" src="http://i57.tinypic.com/fxar8z.jpg"></p>
<p>OK, 现在我们来修改源码, <strong>使 Lua 支持中文的变量名及函数名</strong>.<br>
打开 src 文件夹下的 <strong>llex.c</strong> 文件, 定位到 <strong>static int llex (LexState <em>ls, SemInfo </em>seminfo)</strong> 函数处.<br>
这个函数的主体是 switch 结构, 我们向下翻找到它的 <strong>default</strong> 部分.</p>
<div class="codehilite" style="background: #eeeedd"><pre style="line-height: 125%"><span></span><span style="color: #8B008B; font-weight: bold">default</span>: {
<span style="color: #8B008B; font-weight: bold">if</span> (lislalpha(ls-&gt;current)) {  <span style="color: #228B22">/* identifier or reserved word? */</span>
  TString *ts;
  <span style="color: #8B008B; font-weight: bold">do</span> {
    save_and_next(ls);
  } <span style="color: #8B008B; font-weight: bold">while</span> (lislalnum(ls-&gt;current));

<span style="color: #228B22">// 将上面代码改成下面的</span>
<span style="color: #8B008B; font-weight: bold">default</span>: {
<span style="color: #8B008B; font-weight: bold">if</span> (lislalpha(ls-&gt;current) || ls-&gt;current == <span style="color: #CD5555">&#39;_&#39;</span> ||  ls-&gt;current &gt; <span style="color: #B452CD">0x80</span>) {  <span style="color: #228B22">/* identifier or reserved word? */</span>
  TString *ts;
  <span style="color: #8B008B; font-weight: bold">do</span> {
    save_and_next(ls);
  } <span style="color: #8B008B; font-weight: bold">while</span> (lislalnum(ls-&gt;current) || ls-&gt;current == <span style="color: #CD5555">&#39;_&#39;</span> ||  ls-&gt;current &gt; <span style="color: #B452CD">0x80</span>);
</pre></div>


<p><br>
现在开始来<strong>编译lua解释器(lua.exe).</strong></p>
<p>打开 VS2013 新建一个 win32 控制台程序, 取名为 Lua, 不要勾选预编译头.</p>
<p><img alt="" src="http://i57.tinypic.com/dwc479.jpg"></p>
<p>删除 VS2013 帮我们自动生成的 Lua.cpp.</p>
<p><img alt="" src="http://i57.tinypic.com/2evf6g9.jpg"></p>
<p>接着将 <strong>src</strong> 文件夹下源代码文件复制到工作目录下, 然后在刚新建的工程中添加<strong>除 luac.c 外</strong>的其他文件.<br>
打开属性编辑框, 在工程的预处理器设置中添加一行 <strong>_CRT_SECURE_NO_WARNINGS</strong> (屏蔽 C4996 错误).</p>
<p><img alt="" src="http://i60.tinypic.com/332qpgg.jpg"></p>
<p>最好也设置下程序语言集, 因为 Lua 的源代码都是基于 ASCII 的, 例如:</p>
<div class="codehilite" style="background: #eeeedd"><pre style="line-height: 125%"><span></span><span style="color: #00688B; font-weight: bold">char</span> buff[<span style="color: #B452CD">4</span>*sizeof(<span style="color: #00688B; font-weight: bold">void</span> *) + <span style="color: #B452CD">8</span>]; <span style="color: #228B22">/* should be enough space for a &#39;%p&#39; */</span>
<span style="color: #00688B; font-weight: bold">int</span> l = sprintf(buff, <span style="color: #CD5555">&quot;%p&quot;</span>, va_arg(argp, <span style="color: #00688B; font-weight: bold">void</span> *));
</pre></div>


<p><br>
<img alt="" src="http://i61.tinypic.com/2dryiv5.jpg"></p>
<p>开始 <strong>Release 版本编译</strong>, 就得到我们的lua解释器(lua.exe)了, 将它复制出来保存好.</p>
<p>接下来开始<strong>编译lua编译器(luac.exe)</strong>.</p>
<p>移除 VS2013 工程中之前添加的 lua.c 文件, 添加进 luac.c 文件, 然后再编译, 将编译出来后的 lua.exe 重命名为 luac.exe, 复制出来保存.</p>
<p>接下来开始<strong>编译lua的库文件(*.lib),</strong> 移除 VS2013 工程中刚添加的 luac.c 文件, 打开属性编辑框, 修改配置类为静态库(.lib).</p>
<p><img alt="" src="http://i62.tinypic.com/141jbdt.jpg"></p>
<p>接下开始编译.</p>
<p>注意: lua 的库文件需要编译 Release 和 Debug 两个版本, 另外, 两个版本都要设置下预处理器设置和配置类型.</p>
<p>此时3部分内容都编译完毕:</p>
<p><img alt="" src="http://i59.tinypic.com/2ezln5l.jpg"></p>
<p>我们已经发现到:<br>
其实最关键就是除开不必要的文件;<br>
编译 lua（lua.exe，解析器） 时删除 luac.c，加入 lua.c;<br>
编译 luac（luac.exe，编译器）时删除 lua.c，加入 luac.c;<br>
编译 lib（lua.dll，库）时把 lua.c 和 luac.c 都删除.</p>
<hr>
<p>将下来<strong>设置 Sublime Text, 让它可以运行 lua 命令.</strong></p>
<p><a href="http://hrtsea.com/2014/09/14/sublime-text/">Sublime Text 优化版本下载</a></p>
<p>Tool(工具)-&gt;Build System(编译系统) -&gt; New Build System(新编译系统), 添加如下代码:</p>
<div class="codehilite" style="background: #eeeedd"><pre style="line-height: 125%"><span></span>{
 <span style="color: #CD5555">&quot;cmd&quot;</span>: [<span style="color: #CD5555">&quot;C:/Users/Administrator/Desktop/lua/Release/lua.exe&quot;</span>, <span style="color: #CD5555">&quot;$file&quot;</span>],
 <span style="color: #CD5555">&quot;file_regex&quot;</span>: <span style="color: #CD5555">&quot;^(?:lua:)?[\t](...*?):([0-9]*):?([0-9]*)&quot;</span>,
 <span style="color: #CD5555">&quot;selector&quot;</span>: <span style="color: #CD5555">&quot;source.lua&quot;</span>
}
</pre></div>


<p><br>
保存为 lua.sublime-build 就可以了, 此时 Sublime Text 的编译选项就多出来了 lua.</p>
<p>编辑好 lua 脚本后, 按 ctrl + b, 或者 工具 –&gt; 立即编译 就得到脚本的运行结果了.</p>
<p><img alt="" src="http://i62.tinypic.com/2n8r3uq.jpg"></p>
<p><img alt="" src="http://i59.tinypic.com/2iwaz53.jpg"></p>
<hr>
<p>为了方便以后 C 与 Lua 交互, 整合一下交互开发环境.</p>
<p>建立文件夹 LuaScript, 在 LuaScript 中再创建文件夹 lib 和 include, 将刚才编译的 Lua_Debug.lib 和 Lua_Release.lib 文件添加到 lib 文件夹下, 将 src 文件夹下的<strong> lauxlib.h、lua.h、<strong><em>*luaconf</em></strong>*.h、lualib.h </strong>四个头文件加入到 include 文件夹下.
在 LuaScript 文件夹里再创建一个 LuaEx.h 文件, 添加以下代码:</p>
<div class="codehilite" style="background: #eeeedd"><pre style="line-height: 125%"><span></span><span style="color: #a61717; background-color: #e3d2d2">#</span>pragma once

extern <span style="color: #CD5555">&quot;C&quot;</span> {
<span style="color: #a61717; background-color: #e3d2d2">#</span>include <span style="color: #CD5555">&quot;lua.h&quot;</span>
<span style="color: #a61717; background-color: #e3d2d2">#</span>include <span style="color: #CD5555">&quot;lauxlib.h&quot;</span>
<span style="color: #a61717; background-color: #e3d2d2">#</span>include <span style="color: #CD5555">&quot;lualib.h&quot;</span>
<span style="color: #a61717; background-color: #e3d2d2">#</span>include <span style="color: #CD5555">&quot;luaconf.h&quot;</span>
}

<span style="color: #a61717; background-color: #e3d2d2">#</span>ifdef _DEBUG
<span style="color: #a61717; background-color: #e3d2d2">#</span>pragma <span style="color: #008b45">comment</span>(lib,<span style="color: #CD5555">&quot;Lua_Debug.lib&quot;</span>)
<span style="color: #a61717; background-color: #e3d2d2">#</span><span style="color: #8B008B; font-weight: bold">else</span>
<span style="color: #a61717; background-color: #e3d2d2">#</span>pragma <span style="color: #008b45">comment</span>(lib,<span style="color: #CD5555">&quot;Lua_Release.lib&quot;</span>)
<span style="color: #a61717; background-color: #e3d2d2">#</span>endif
</pre></div>


<p><br>
以后, 如果 vs2013 中要用到 lua, 就将 LuaScript 文件夹复制到工程目录下, 然后设置当前工程的包含目录和库目录, 再在需要的地方 #include &ldquo;LuaEx.h&rdquo; 就可以了.</p>
<p><img alt="" src="http://i62.tinypic.com/29bev89.jpg"></p>
<p><img alt="" src="http://i59.tinypic.com/2csb4n4.jpg"></p>
            <div align="center" style="color:#ccc;">☠</div>
        </div>
    </article>
</section>
  </article>


</body>
</html>