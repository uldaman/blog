<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=device-width" />

    <title>025、内部类应用</title>

    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/normalize.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/foundation.min.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/style.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/pygments.css" />
    <link rel="shortcut icon" type="image/x-icon" href="http://blog.smallcpp.com/theme/images/favicon.ico" />
    <script src="http://blog.smallcpp.com/theme/js/modernizr.js"></script>
</head>

<body>

<!-- Nav Bar -->
<nav>
<div class="top-bar">
<div class="row">
    <div class="large-9 large-centered columns">
	    <h1><a href="http://blog.smallcpp.com">Small Cpp | 勿在浮沙筑高台, 练从难处练, 用从易处用.</a></h1>
    </div>
</div>
</div>

<!-- Show menu items and pages -->
<div class="row">
<div class="large-9 columns">
    <ul class="button-group navigation">

    </ul>
</div>
</div>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->
<div class="row">

    <!-- Main Blog Content -->
    <div class="large-9 columns">
<article>
    <header>
        <h3 class="article-title"><a href="http://blog.smallcpp.com/025-nei-bu-lei-ying-yong.html" rel="bookmark"
        title="Permalink to 025、内部类应用">025、内部类应用</a></h3>
    </header>

<h6 class="subheader" title="2016-03-16T15:21:00+08:00">Wed 16 March 2016
</h6>


    <div class="toc">
<ul>
<li><a href="#1">1. 多重继承</a></li>
<li><a href="#2">2. 闭包与回调</a></li>
</ul>
</div>
<h2 id="1"><a name="user-content-1" href="#1" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>1. 多重继承</h2>
<p>内部类最吸引的原因是: 每个内部类都能独立地继承/实现一个类/接口.</p>
<p>这样就为类提供了__&rdquo;多重继承&rdquo;__的可能.</p>
<div class="codehilite" style="background: #F7F7F7"><pre style="line-height: 125%"><span></span><span style="color: #A71D5D">class</span> <span style="color: #445588">D</span> <span style="color: #A71D7E">{</span>
<span style="color: #A71D7E">}</span>

<span style="color: #A71D5D">class</span> <span style="color: #445588">E</span> <span style="color: #A71D7E">{</span>
<span style="color: #A71D7E">}</span>

<span style="color: #A71D5D">class</span> <span style="color: #445588">O</span> <span style="color: #A71D5D">extends</span> <span style="color: #333333">D</span> <span style="color: #A71D7E">{</span> <span style="color: #999988; font-style: italic">// 外部类继承 D</span>

    <span style="color: #A71D5D">class</span> <span style="color: #445588">I</span> <span style="color: #A71D5D">extends</span> <span style="color: #333333">E</span> <span style="color: #A71D7E">{</span> <span style="color: #999988; font-style: italic">// 内部类继承 E</span>
    <span style="color: #A71D7E">}</span>

    <span style="color: #A71D5D">public</span> <span style="color: #333333">E</span> <span style="color: #795DA3">makeE</span><span style="color: #A71D7E">()</span> <span style="color: #A71D7E">{</span>
        <span style="color: #A71D5D">return</span> <span style="color: #A71D5D">new</span> <span style="color: #333333">I</span><span style="color: #A71D7E">();</span>
    <span style="color: #A71D7E">}</span>
<span style="color: #A71D7E">}</span>

<span style="color: #A71D5D">public</span> <span style="color: #A71D5D">class</span> <span style="color: #445588">TestDemo</span> <span style="color: #A71D7E">{</span>
    <span style="color: #A71D5D">static</span> <span style="color: #A71D5D">public</span> <span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #795DA3">takesD</span><span style="color: #A71D7E">(</span><span style="color: #333333">D</span> <span style="color: #333333">d</span><span style="color: #A71D7E">)</span> <span style="color: #A71D7E">{</span>
    <span style="color: #A71D7E">}</span>

    <span style="color: #A71D5D">static</span> <span style="color: #A71D5D">public</span> <span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #795DA3">takesE</span><span style="color: #A71D7E">(</span><span style="color: #333333">E</span> <span style="color: #333333">e</span><span style="color: #A71D7E">)</span> <span style="color: #A71D7E">{</span>
    <span style="color: #A71D7E">}</span>

    <span style="color: #A71D5D">public</span> <span style="color: #A71D5D">static</span> <span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #795DA3">main</span><span style="color: #A71D7E">(</span><span style="color: #333333">String</span><span style="color: #A71D7E">[]</span> <span style="color: #333333">args</span><span style="color: #A71D7E">)</span> <span style="color: #A71D7E">{</span>
        <span style="color: #333333">O</span> <span style="color: #333333">o</span> <span style="color: #A71D7E">=</span> <span style="color: #A71D5D">new</span> <span style="color: #333333">O</span><span style="color: #A71D7E">();</span>
        <span style="color: #333333">takesD</span><span style="color: #A71D7E">(</span><span style="color: #333333">o</span><span style="color: #A71D7E">);</span>
        <span style="color: #333333">takesE</span><span style="color: #A71D7E">(</span><span style="color: #333333">o</span><span style="color: #A71D7E">.</span><span style="color: #008080">makeE</span><span style="color: #A71D7E">());</span>
    <span style="color: #A71D7E">}</span>
<span style="color: #A71D7E">}</span>
</pre></div>


<p>如上面的代码, 我们的类 O 本身继承了 D, 又可以通过 makeE() 方法返回一个继承 E 的对象, 这就相当于&rdquo;多重继承&rdquo;: 让类 O &ldquo;拥有&rdquo;了类 D 和 类 E 的特征.<br>
如果你还有一个类需要被继承, 可以在类 O 里再添加一个内部类, 用它来继承那个类.</p>
<h2 id="2"><a name="user-content-2" href="#2" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>2. 闭包与回调</h2>
<blockquote>
<p>闭包貌似是在 Java8 中才被引进的, 但我在使用其他语言(Lua、Python)时, 早已接触过闭包了.</p>
</blockquote>
<p>在 Lua 中, 可以这么解释闭包:<br>
如果在一个内部函数里, 对外部作用域(但又不是在全局作用域)的变量进行引用, 那么内部函数就被认为是闭包(closure).</p>
<p>更官方的一点定义是:<br>
闭包(closure)是一个可调用的对象, 它记录了一些信息, 这些信息来自于创建它的作用域.</p>
<p>通过这个定义, 可以看出, java 中的内部类就是一个面向对象的闭包, 因为它不仅包含其外部类对象(创建内部类的作用域)的信息, 还自动拥有一个__指向此外部类对象的引用__, 在此作用域内, 内部类有权操作外部类的所有成员.</p>
<p>而所谓的__回调__, 就是通过传递对象的一些信息, 然后在稍后的某个时刻允许这些信息调用其初始的对象, 在 C 中这一般通过传递对象的指针来实现, 而指针的弊端嘛&hellip;大家都懂的;</p>
<p>在 Java 中, 内部类提供的闭包功能是一个优良的替代方案, 它比指针灵活、安全.</p>
<div class="codehilite" style="background: #F7F7F7"><pre style="line-height: 125%"><span></span><span style="color: #A71D5D">interface</span> <span style="color: #445588">Incrementable</span> <span style="color: #A71D7E">{</span> <span style="color: #999988; font-style: italic">// 一个计数器接口</span>
    <span style="color: #A71D5D">public</span> <span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #795DA3">increment</span><span style="color: #A71D7E">();</span>
<span style="color: #A71D7E">}</span>

<span style="color: #A71D5D">class</span> <span style="color: #445588">Caller</span> <span style="color: #A71D7E">{</span>
    <span style="color: #A71D5D">private</span> <span style="color: #333333">Incrementable</span> <span style="color: #333333">callbackReference</span><span style="color: #A71D7E">;</span>

    <span style="color: #333333">Caller</span><span style="color: #A71D7E">(</span><span style="color: #333333">Incrementable</span> <span style="color: #333333">cbh</span><span style="color: #A71D7E">)</span> <span style="color: #A71D7E">{</span>
        <span style="color: #333333">callbackReference</span> <span style="color: #A71D7E">=</span> <span style="color: #333333">cbh</span><span style="color: #A71D7E">;</span>
    <span style="color: #A71D7E">}</span>

    <span style="color: #A71D5D">public</span> <span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #795DA3">run</span><span style="color: #A71D7E">()</span> <span style="color: #A71D7E">{</span>
        <span style="color: #333333">callbackReference</span><span style="color: #A71D7E">.</span><span style="color: #008080">increment</span><span style="color: #A71D7E">();</span> <span style="color: #999988; font-style: italic">// 通过引用回调 increment() 方法</span>
    <span style="color: #A71D7E">}</span>
<span style="color: #A71D7E">}</span>

<span style="color: #A71D5D">class</span> <span style="color: #445588">Callee1</span> <span style="color: #A71D5D">implements</span> <span style="color: #333333">Incrementable</span> <span style="color: #A71D7E">{</span> <span style="color: #999988; font-style: italic">// 实现接口</span>
    <span style="color: #A71D5D">private</span> <span style="color: #A71D5D; font-weight: bold">int</span> <span style="color: #333333">i</span> <span style="color: #A71D7E">=</span> <span style="color: #0086b3">0</span><span style="color: #A71D7E">;</span>

    <span style="color: #A71D5D">public</span> <span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #795DA3">increment</span><span style="color: #A71D7E">()</span> <span style="color: #A71D7E">{</span>
        <span style="color: #333333">System</span><span style="color: #A71D7E">.</span><span style="color: #008080">out</span><span style="color: #A71D7E">.</span><span style="color: #008080">println</span><span style="color: #A71D7E">(</span><span style="color: #183691">&quot;一个计数器&quot;</span><span style="color: #A71D7E">);</span>
        <span style="color: #333333">i</span><span style="color: #A71D7E">++;</span>
        <span style="color: #333333">System</span><span style="color: #A71D7E">.</span><span style="color: #008080">out</span><span style="color: #A71D7E">.</span><span style="color: #008080">println</span><span style="color: #A71D7E">(</span><span style="color: #333333">i</span><span style="color: #A71D7E">);</span>
    <span style="color: #A71D7E">}</span>
<span style="color: #A71D7E">}</span>

<span style="color: #A71D5D">abstract</span> <span style="color: #A71D5D">class</span> <span style="color: #445588">MyIncrement</span> <span style="color: #A71D7E">{</span> <span style="color: #999988; font-style: italic">// 一个计数器抽象类</span>
    <span style="color: #A71D5D">abstract</span> <span style="color: #A71D5D">public</span> <span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #795DA3">increment</span><span style="color: #A71D7E">();</span>
<span style="color: #A71D7E">}</span>

<span style="color: #A71D5D">class</span> <span style="color: #445588">Callee2</span> <span style="color: #A71D5D">extends</span> <span style="color: #333333">MyIncrement</span> <span style="color: #A71D7E">{</span>
    <span style="color: #A71D5D">private</span> <span style="color: #A71D5D; font-weight: bold">int</span> <span style="color: #333333">i</span> <span style="color: #A71D7E">=</span> <span style="color: #0086b3">10</span><span style="color: #A71D7E">;</span>

    <span style="color: #A71D5D">public</span> <span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #795DA3">increment</span><span style="color: #A71D7E">()</span> <span style="color: #A71D7E">{</span> <span style="color: #999988; font-style: italic">// 重写</span>
        <span style="color: #333333">System</span><span style="color: #A71D7E">.</span><span style="color: #008080">out</span><span style="color: #A71D7E">.</span><span style="color: #008080">println</span><span style="color: #A71D7E">(</span><span style="color: #183691">&quot;另一个计数器&quot;</span><span style="color: #A71D7E">);</span>
        <span style="color: #333333">i</span><span style="color: #A71D7E">++;</span>
        <span style="color: #333333">System</span><span style="color: #A71D7E">.</span><span style="color: #008080">out</span><span style="color: #A71D7E">.</span><span style="color: #008080">println</span><span style="color: #A71D7E">(</span><span style="color: #333333">i</span><span style="color: #A71D7E">);</span>
    <span style="color: #A71D7E">}</span>

    <span style="color: #A71D5D">private</span> <span style="color: #A71D5D">class</span> <span style="color: #445588">Closure</span> <span style="color: #A71D5D">implements</span> <span style="color: #333333">Incrementable</span> <span style="color: #A71D7E">{</span>
        <span style="color: #A71D5D">public</span> <span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #795DA3">increment</span><span style="color: #A71D7E">()</span> <span style="color: #A71D7E">{</span> <span style="color: #999988; font-style: italic">// 实现, 提供一个外部类的 Hook</span>
            <span style="color: #333333">Callee2</span><span style="color: #A71D7E">.</span><span style="color: #008080">this</span><span style="color: #A71D7E">.</span><span style="color: #008080">increment</span><span style="color: #A71D7E">();</span>
        <span style="color: #A71D7E">}</span>
    <span style="color: #A71D7E">}</span>

    <span style="color: #A71D5D">public</span> <span style="color: #333333">Incrementable</span> <span style="color: #795DA3">getCallbackReference</span><span style="color: #A71D7E">()</span> <span style="color: #A71D7E">{</span> <span style="color: #999988; font-style: italic">// 返回一个 Incrementable 引用, 任何人拿到这个引用也只能调用 increment() 方法</span>
        <span style="color: #A71D5D">return</span> <span style="color: #A71D5D">new</span> <span style="color: #333333">Closure</span><span style="color: #A71D7E">();</span>
    <span style="color: #A71D7E">}</span>

    <span style="color: #999988; font-style: italic">// 其它方法</span>
<span style="color: #A71D7E">}</span>

<span style="color: #A71D5D">public</span> <span style="color: #A71D5D">class</span> <span style="color: #445588">TestDemo</span> <span style="color: #A71D7E">{</span>

    <span style="color: #A71D5D">public</span> <span style="color: #A71D5D">static</span> <span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #795DA3">main</span><span style="color: #A71D7E">(</span><span style="color: #333333">String</span><span style="color: #A71D7E">[]</span> <span style="color: #333333">args</span><span style="color: #A71D7E">)</span> <span style="color: #A71D7E">{</span>
        <span style="color: #333333">Callee1</span> <span style="color: #333333">c1</span> <span style="color: #A71D7E">=</span> <span style="color: #A71D5D">new</span> <span style="color: #333333">Callee1</span><span style="color: #A71D7E">();</span>
        <span style="color: #333333">Caller</span> <span style="color: #333333">caller1</span> <span style="color: #A71D7E">=</span> <span style="color: #A71D5D">new</span> <span style="color: #333333">Caller</span><span style="color: #A71D7E">(</span><span style="color: #333333">c1</span><span style="color: #A71D7E">);</span> <span style="color: #999988; font-style: italic">// 设置回调</span>
        <span style="color: #333333">caller1</span><span style="color: #A71D7E">.</span><span style="color: #008080">run</span><span style="color: #A71D7E">();</span>

        <span style="color: #333333">Callee2</span> <span style="color: #333333">c2</span> <span style="color: #A71D7E">=</span> <span style="color: #A71D5D">new</span> <span style="color: #333333">Callee2</span><span style="color: #A71D7E">();</span>
        <span style="color: #333333">Caller</span> <span style="color: #333333">caller2</span> <span style="color: #A71D7E">=</span> <span style="color: #A71D5D">new</span> <span style="color: #333333">Caller</span><span style="color: #A71D7E">(</span><span style="color: #333333">c2</span><span style="color: #A71D7E">.</span><span style="color: #008080">getCallbackReference</span><span style="color: #A71D7E">());</span> <span style="color: #999988; font-style: italic">// 设置回调</span>
        <span style="color: #333333">caller2</span><span style="color: #A71D7E">.</span><span style="color: #008080">run</span><span style="color: #A71D7E">();</span>
    <span style="color: #A71D7E">}</span>
<span style="color: #A71D7E">}</span>
</pre></div>


<p>Caller 的构造函数需要一个 Incrementable 的引用来作为参数, 然后在稍后的某个时刻, Caller 对象可以使用此引用回调 increment() 方法.</p>
<blockquote>
<p>回调价值在于它的灵活性, 可以在运行时动态地决定需要调用什么方法(根据你传递的引用参数).</p>
</blockquote>
<p>假设我们需要一个计数功能, Callee1 是一个简单的解决方法, 它单独地去实现 Incrementable 接口, 然后传给 Caller 的构造函数, 这没什么好说的.</p>
<p>主要看 Callee2, 它继承于 MyIncrement, 它也有一个 increment() 方法, 我们希望能够让 Caller 去回调这个方法, 但是可惜的是 Callee2 并不实现 Incrementable 接口, 所以不能传递给 Caller 的构造函数.</p>
<p>所幸, 我们还有内部类 Closure, 这个内部类实现了 Incrementable, 并提供一个其外部类 Callee2 的 &ldquo;Hook&rdquo;, 而且是一个安全的 &ldquo;Hook&rdquo;, 这样, 无论谁拿到 Closure 引用, 都只能调用 Callee2 的 increment() 方法, 而不能去操作 Callee2 的其它成员.</p>
<p>这也是为什么说内部类比指针更灵活, 安全的原因.<br>
因为, 如果你得到了某个对象的指针, 相当于拥有了这个对象的完全控制权, 而内部类不一样, 它是可控的, 你可以在内部类中指定要 &ldquo;Hook&rdquo; 的成员, 例如刚才的例子, 我们就只 &ldquo;Hook&rdquo; 了 increment() 方法.</p>
<p class="subheader">Category: <a href="http://blog.smallcpp.com/category/da-shu-ju-java-ji-chu.html">大数据 Java 基础</a>

</p>




<!--      -->

    <!-- 多说评论框 start -->
    <h4>Comments !</h4>
    <div class="ds-thread" data-thread-key="025-nei-bu-lei-ying-yong" data-title="025、内部类应用" data-url="http://blog.smallcpp.com/025-nei-bu-lei-ying-yong.html"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
        var duoshuoQuery = {short_name:"smallcpp"};
            (function() {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';ds.async = true;
                ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
    </script>
    <!-- 多说公共JS代码 end -->
</article>
    </div>
    <!-- End Main Content -->

    <!-- Sidebar -->
    <aside class="large-3 columns">
        <h5 class="sidebar-title">Site</h5>
        <ul class="side-nav">
            <li><a href="http://blog.smallcpp.com/archives.html">Archives</a>
            <li><a href="http://blog.smallcpp.com/tags.html">Tags</a>
        </ul>

        <h5 class="sidebar-title">Categories</h5>
        <ul class="side-nav">
            <li><a href="http://blog.smallcpp.com/category/ban-ben-kong-zhi.html">版本控制</a></li>
            <li><a href="http://blog.smallcpp.com/category/c11-xin-te-xing.html">C++11 新特性</a></li>
            <li><a href="http://blog.smallcpp.com/category/cocos2d-you-xi-kai-fa.html">Cocos2d 游戏开发</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-hua-she-ji-mo-shi.html">大话设计模式</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-shu-ju-hadoop.html">大数据 Hadoop</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-shu-ju-java-ji-chu.html">大数据 Java 基础</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-shu-ju-linux-ji-chu.html">大数据 Linux 基础</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-shu-ju-mongodb-ji-chu.html">大数据 Mongodb 基础</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-shu-ju-redis-ji-chu.html">大数据 Redis 基础</a></li>
            <li><a href="http://blog.smallcpp.com/category/du-shu-bi-ji.html">读书笔记</a></li>
            <li><a href="http://blog.smallcpp.com/category/golang.html">Golang</a></li>
            <li><a href="http://blog.smallcpp.com/category/hei-ke-ji.html">黑科技</a></li>
            <li><a href="http://blog.smallcpp.com/category/ling-ji-chu-qt-ru-men.html">零基础 QT 入门</a></li>
            <li><a href="http://blog.smallcpp.com/category/lua-you-xi-kai-fa.html">Lua 游戏开发</a></li>
            <li><a href="http://blog.smallcpp.com/category/pyqt-kai-fa.html">PyQt 开发</a></li>
            <li><a href="http://blog.smallcpp.com/category/python-cong-ru-men-dao-fang-qi.html">Python 从入门到放弃</a></li>
            <li><a href="http://blog.smallcpp.com/category/za-xiang.html">杂项</a></li>
            <li><a href="http://blog.smallcpp.com/category/zai-xue-java.html">再学 JAVA</a></li>
        </ul>

        <h5 class="sidebar-title">Links</h5>
        <ul class="side-nav">
            <li><a href="http://blog.csdn.net/u010850265">CSDN</a></li>
        </ul>

        <h5 class="sidebar-title">Social</h5>
        <ul class="side-nav">
            <li><a href="http://blog.csdn.net/u010850265">CSDN</a></li>
        </ul>

    </aside> <!-- End Sidebar -->

</div> <!-- End Main Content and Sidebar -->


<!-- Footer -->
<footer class="row">
    <div class="large-12 columns">
        <hr />
        <div class="row">
            <div class="large-6 columns">
              <!--                  <p>Small Cpp | 勿在浮沙筑高台, 练从难处练, 用从易处用. by martin</p> -->
            </div>
            </div>
    </div>
</footer>
</body>
</html>