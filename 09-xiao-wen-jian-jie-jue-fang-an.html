<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <!-- Site Meta Data -->
  <title>09. 小文件解决方案</title>
  <meta name="description" content="">
  <meta name="author" content="martin">

  <!-- Style Meta Data -->
  <link rel="stylesheet" href="http://blog.smallcpp.cn/theme/css/notebook.css" type="text/css" />
  <link rel="shortcut icon" href="http://blog.smallcpp.cn/theme/images/avatar.png">

  <!-- Feed Meta Data -->
  <link href="http://blog.smallcpp.cn/" type="application/atom+xml" rel="alternate" title="Small Cpp ATOM Feed" />

  <!-- Twitter Feed -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="">
  <meta name="twitter:image" content="http://blog.smallcpp.cn/theme/images/avatar.png">

<meta name="twitter:creator" content="">
<meta name="twitter:url" content="http://blog.smallcpp.cn/09-xiao-wen-jian-jie-jue-fang-an.html">
<meta name="twitter:title" content="Small Cpp ~ 09. 小文件解决方案">
<meta name="twitter:description" content="小文件解决方案">

<!-- Facebook Meta Data -->
<meta property="og:title" content="Small Cpp ~ 09. 小文件解决方案" />
<meta property="og:description" content="小文件解决方案" />
<meta property="og:image" content="theme/images/avatar.png" />
</head>

<body>
  <!-- Sidebar -->
  <aside>
    <p><a href="http://blog.smallcpp.cn"><img id="avatar" src="http://blog.smallcpp.cn/theme/images/avatar.png"></a></p>
    <h1>Small Cpp</h1>
    <p>勿在浮沙筑高台, 练从难处练, 用从易处用.</p>
    <hr>
    <h2>Social</h2>
    <ul class="social">
      <a href="http://blog.csdn.net/u010850265">CSDN</a></li>
    </ul>
    <h2>Categories</h2>
    <ul class="navbar">
      <li><a href="http://blog.smallcpp.cn/category/c11.html">C++11</a></li>
      <li class="active"><a href="http://blog.smallcpp.cn/category/da-shu-ju.html">大数据</a></li>
      <li><a href="http://blog.smallcpp.cn/category/du-shu-bi-ji.html">读书笔记</a></li>
      <li><a href="http://blog.smallcpp.cn/category/golang.html">Golang</a></li>
      <li><a href="http://blog.smallcpp.cn/category/hei-ke-ji.html">黑科技</a></li>
      <li><a href="http://blog.smallcpp.cn/category/java.html">Java</a></li>
      <li><a href="http://blog.smallcpp.cn/category/linux.html">Linux</a></li>
      <li><a href="http://blog.smallcpp.cn/category/lua.html">Lua</a></li>
      <li><a href="http://blog.smallcpp.cn/category/mongodb.html">Mongodb</a></li>
      <li><a href="http://blog.smallcpp.cn/category/pyqt.html">PyQt</a></li>
      <li><a href="http://blog.smallcpp.cn/category/python.html">Python</a></li>
      <li><a href="http://blog.smallcpp.cn/category/qt.html">QT</a></li>
      <li><a href="http://blog.smallcpp.cn/category/qu-kuai-lian.html">区块链</a></li>
      <li><a href="http://blog.smallcpp.cn/category/redis.html">Redis</a></li>
      <li><a href="http://blog.smallcpp.cn/category/ruan-jian-she-ji.html">软件设计</a></li>
      <li><a href="http://blog.smallcpp.cn/category/za-xiang.html">杂项</a></li>
    </ul> 
  </aside>

  <!-- Content -->
  <article>
<section id="content">
    <article>
        <header class="post_list">
            <h2 class="post_title"><a href="http://blog.smallcpp.cn/09-xiao-wen-jian-jie-jue-fang-an.html" rel="bookmark" title="Permalink to 09. 小文件解决方案">09. 小文件解决方案</a></h2>
            <span>Par </span>
            <a href="http://blog.smallcpp.cn/author/martin.html">@Martin</a>
            <span> dans </span>
            <span class="post_category"><a href="http://blog.smallcpp.cn/category/da-shu-ju.html" rel="bookmark" title="Permalink to 大数据">[ 大数据 ]</a></span>
            <span> le </span>
            <span class="post_date">Wed 23 November 2016</span>
            <div></div>
            <div><span>Tags : </span>
            </div>
        </header>
        <div class="entry-content">
            <div class="toc">
<ul>
<li><a href="#_1">可选方案</a></li>
<li><a href="#hadoop-archives">Hadoop Archives</a></li>
</ul>
</div>
<blockquote>
<p>所谓的小文件指的是小于一个 block size 的文件.</p>
</blockquote>
<h1 id="_1">可选方案</h1>
<p>对于<strong>尚未上传</strong>到 HDFS 的文件, 可以采用以下几种方案:</p>
<ul>
<li>应用程序自己合并文件上传 (要根据实际情况来, 因为上传后不好处理)</li>
<li>SequenceFile/MapFile, 同样需要自己编程上传文件, 上传的数据将被打包成 k, v 的形式</li>
</ul>
<blockquote>
<p>通常对于 &ldquo;the small files problem&rdquo; 的回应会是: 使用 SequenceFile.<br>
这种方法是说, 使用 filename 作为 key, 而 file contents 作为 value.</p>
</blockquote>
<p>对于<strong>已存在</strong>于 HDFS 上的文件, 可以使用:</p>
<ul>
<li>Hadoop Archives (HAR files, 类似 zip/rar 的文件归档功能, 打完包后, 需要<strong>手动删除</strong>被打包前的文件)</li>
<li>CombineFileInputFormat (MR 的内容)</li>
<li>HBase compact (HBase 的内容, 把多个 HFile 合并成一个 HFile)</li>
</ul>
<p>CombineFileInputFormat 及 HBase compact 将在后面的 MR 及 HBase 专题记录, 本篇介绍下 Hadoop Archives.</p>
<h1 id="hadoop-archives">Hadoop Archives</h1>
<p><strong>References</strong>:<br>
<a href="http://blog.csdn.net/lastsweetop/article/details/9123155">Hadoop 深入研究: (五) —— Archives</a><br>
<a href="https://my.oschina.net/u/270950/blog/170570">Hadoop 关于处理大量小文件的问题和解决方法</a></p>
<p>Hadoop Archives (HAR files) 是在 0.18.0 版本中引入的, 它的出现就是为了缓解大量小文件消耗 NameNode 内存的问题.</p>
<p>HAR 文件是通过在 HDFS 上构建一个层次化的文件系统来工作, HAR 文件一旦创建便不可再更改.</p>
<p><img alt="" src="http://blog.smallcpp.cn/theme/images/小文件处理/harindex.png"></p>
<p>HAR 文件通过 Hadoop 的 Archive 命令来创建, 而这个命令实际上也是运行了一个 <strong>MapReduce</strong> 任务来将小文件打包成 HAR.</p>
<p>对于 client 端来说, 使用 HAR 文件没有任何影响, 所有的原始文件都可见&amp;&amp;透明, 但在HDFS端它内部的文件数减少了.</p>
<p>通过 HAR 来读取一个文件并不会比直接从 HDFS 中读取文件高效, 而且实际上可能还会稍微<strong>低效</strong>一点, 因为对每一个 HAR 文件的访问都需要完成两层 index 文件的读取和文件本身数据的读取 (见上图). 并且尽管 HAR 文件可以被用来作为 <strong>MapReduce job</strong> 的 input, 但是并没有特殊的方法来使 maps 将 HAR 文件中打包的文件当作一个 HDFS 文件处理.</p>
<p>总结一下就是说 HAR:</p>
<ul>
<li>通过将小文件打包成一个大文件来减少 NameNode 的内存消耗</li>
<li>虽然可以 HAR 当成一个包传递成 Map 任务, 但是实际处理时, 并不是将它看作一个文件, 而是以打包前的数据进行处理</li>
</ul>
<p><strong>创建文件</strong>: <code>hadoop archive -archiveName xxx.har -p  /src  /dest</code> (-p 参数指定要打包的目录和目的地目录)</p>
<p><strong>查看内容</strong>: <code>hadoop fs -lsr har:///dest/xxx.har</code> (注意 har:/// 协议)</p>
            <div align="center" style="color:#ccc;">☠</div>
        </div>
    </article>
</section>
  </article>


</body>
</html>