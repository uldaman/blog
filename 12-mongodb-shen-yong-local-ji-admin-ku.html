<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <!-- Site Meta Data -->
  <title>12、Mongodb 慎用 local 及 admin 库</title>
  <meta name="description" content="">
  <meta name="author" content="martin">

  <!-- Style Meta Data -->
  <link rel="stylesheet" href="http://blog.smallcpp.cn/theme/css/notebook.css" type="text/css" />
  <link rel="shortcut icon" href="http://blog.smallcpp.cn/theme/images/avatar.png">

  <!-- Feed Meta Data -->
  <link href="http://blog.smallcpp.cn/" type="application/atom+xml" rel="alternate" title="Small Cpp ATOM Feed" />

  <!-- Twitter Feed -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="">
  <meta name="twitter:image" content="http://blog.smallcpp.cn/theme/images/avatar.png">

<meta name="twitter:creator" content="">
<meta name="twitter:url" content="http://blog.smallcpp.cn/12-mongodb-shen-yong-local-ji-admin-ku.html">
<meta name="twitter:title" content="Small Cpp ~ 12、Mongodb 慎用 local 及 admin 库">
<meta name="twitter:description" content="MongoDB 副本集默认会创建 local、admin 数据库, local 数据库主要存储副本集的元数据, admin 数据库则主要存储 MongoDB 的用户、角色等信息">

<!-- Facebook Meta Data -->
<meta property="og:title" content="Small Cpp ~ 12、Mongodb 慎用 local 及 admin 库" />
<meta property="og:description" content="MongoDB 副本集默认会创建 local、admin 数据库, local 数据库主要存储副本集的元数据, admin 数据库则主要存储 MongoDB 的用户、角色等信息" />
<meta property="og:image" content="theme/images/avatar.png" />
</head>

<body>
  <!-- Sidebar -->
  <aside>
    <p><a href="http://blog.smallcpp.cn"><img id="avatar" src="http://blog.smallcpp.cn/theme/images/avatar.png"></a></p>
    <h1>Small Cpp</h1>
    <p>勿在浮沙筑高台, 练从难处练, 用从易处用.</p>
    <hr>
    <h2>Social</h2>
    <ul class="social">
      <a href="http://blog.csdn.net/u010850265">CSDN</a></li>
    </ul>
    <h2>Categories</h2>
    <ul class="navbar">
      <li><a href="http://blog.smallcpp.cn/category/c11.html">C++11</a></li>
      <li><a href="http://blog.smallcpp.cn/category/da-shu-ju.html">大数据</a></li>
      <li><a href="http://blog.smallcpp.cn/category/du-shu-bi-ji.html">读书笔记</a></li>
      <li><a href="http://blog.smallcpp.cn/category/golang.html">Golang</a></li>
      <li><a href="http://blog.smallcpp.cn/category/hei-ke-ji.html">黑科技</a></li>
      <li><a href="http://blog.smallcpp.cn/category/java.html">Java</a></li>
      <li><a href="http://blog.smallcpp.cn/category/linux.html">Linux</a></li>
      <li><a href="http://blog.smallcpp.cn/category/lua.html">Lua</a></li>
      <li class="active"><a href="http://blog.smallcpp.cn/category/mongodb.html">Mongodb</a></li>
      <li><a href="http://blog.smallcpp.cn/category/pyqt.html">PyQt</a></li>
      <li><a href="http://blog.smallcpp.cn/category/python.html">Python</a></li>
      <li><a href="http://blog.smallcpp.cn/category/qt.html">QT</a></li>
      <li><a href="http://blog.smallcpp.cn/category/qu-kuai-lian.html">区块链</a></li>
      <li><a href="http://blog.smallcpp.cn/category/redis.html">Redis</a></li>
      <li><a href="http://blog.smallcpp.cn/category/ruan-jian-she-ji.html">软件设计</a></li>
      <li><a href="http://blog.smallcpp.cn/category/za-xiang.html">杂项</a></li>
    </ul> 
  </aside>

  <!-- Content -->
  <article>
<section id="content">
    <article>
        <header class="post_list">
            <h2 class="post_title"><a href="http://blog.smallcpp.cn/12-mongodb-shen-yong-local-ji-admin-ku.html" rel="bookmark" title="Permalink to 12、Mongodb 慎用 local 及 admin 库">12、Mongodb 慎用 local 及 admin 库</a></h2>
            <span>Par </span>
            <a href="http://blog.smallcpp.cn/author/martin.html">@Martin</a>
            <span> dans </span>
            <span class="post_category"><a href="http://blog.smallcpp.cn/category/mongodb.html" rel="bookmark" title="Permalink to Mongodb">[ Mongodb ]</a></span>
            <span> le </span>
            <span class="post_date">Mon 18 April 2016</span>
            <div></div>
            <div><span>Tags : </span>
            </div>
        </header>
        <div class="entry-content">
            <div class="toc">
<ul>
<li><a href="#1-local">1. 慎用 local 数据库</a></li>
<li><a href="#2-admin">2. 慎用 admin 数据库</a></li>
</ul>
</div>
<h1 id="1-local">1. 慎用 local 数据库</h1>
<p>local 数据库, 从名字可以看出, 它只会在本地存储数据, 即 local 数据库里的内容不会同步到副本集里其他节点上去; 目前 local 数据库主要存储副本集的配置信息、oplog 信息, 这些信息是每个 Mongod 进程独有的, 不需要同步到副本集种其他节点.</p>
<p>在使用 MongoDB 时, 重要的数据千万不要存储在 local 数据库中, 否则当一个节点故障时, 存储在 local 里的数据就会丢失.</p>
<p>另外, 对于重要的数据, 除了不能存储在 local 数据库, 还要注意 MongoDB 默认的 WriteConcern 是 <strong>{w: 1}</strong>, 即数据写到 Primary 上(不保证 journal 已经写成功)就向客户端确认, 这时同样存在丢数据的风险.<br>
对于重要的数据, 可以设置更高级别的如 <strong>{w: &ldquo;majority&rdquo;}</strong> 来保证数据写到大多数节点后再向客户端确认, 当然这对写入的性能会造成一定的影响.</p>
<h1 id="2-admin">2. 慎用 admin 数据库</h1>
<p>当 Mongod 启用 auth 选项时, 用户需要创建数据库帐号, 访问时根据帐号信息来鉴权, 而数据库帐号信息就存储在 admin 数据库下.</p>
<div class="codehilite" style="background: #eeeedd"><pre style="line-height: 125%"><span></span>use admin
db.getCollectionNames()
[ &quot;system.users&quot;, &quot;system.version&quot; ]
</pre></div>


<p><br></p>
<ul>
<li>system.users 存储了数据库帐号信息</li>
<li>system.version 存储 authSchema 的版本信息</li>
<li>如果用户创建了自定义的角色, 还会有 system.roles 集合</li>
</ul>
<p>用户可以在 admin 数据库下建立任意集合, 存储任何数据, 但__强烈__建议不要使用 admin 数据库存储应用业务数据, 最好创建新的数据库.</p>
<p>admin 数据库里的 system.users、system.roles 2 个集合的数据, MongoDB 会 cache 在内存里, 这样不用每次鉴权都从磁盘加载用户角色信息.<br>
目前 cache 的维护代码, 只有在保证 system.users、system.roles 的写入都串行化的情况下才能正确工作, 详情参考官方 issue <a href="https://jira.mongodb.org/browse/SERVER-16092">SERVER-16092</a></p>
<p>从代码中我们可以看出, MongoDB 将 admin 数据库上的__意向写锁__(MODE_IX)直接升级为__写锁__(MODE_X), 也就是说 admin 数据库的写入操作的锁级别只能到 DB 级别, 不支持多个 collection 并发写入, 在写入时也不支持并发读取.<br>
所以, 如果用户在 admin 数据库里存储业务数据, 则可能遭遇性能问题.</p>
<div class="codehilite" style="background: #eeeedd"><pre style="line-height: 125%"><span></span>if (supportsDocLocking() || enableCollectionLocking) {
    if (supportsDocLocking() || enableCollectionLocking) {
    // The check for the admin db is to ensure direct writes to auth collections
    // are serialized (see SERVER-16092).
    if (_id == resourceIdAdminDB &amp;amp;&amp;amp; !isRead) {
    _mode = MODE_X;
}

_lockState-&amp;gt;lock(_id, _mode);
</pre></div>


<p><br></p>
            <div align="center" style="color:#ccc;">☠</div>
        </div>
    </article>
</section>
  </article>


</body>
</html>