<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=device-width" />

    <title>Python Supervisor</title>

    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/normalize.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/foundation.min.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/style.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/pygments.css" />
    <link rel="shortcut icon" type="image/x-icon" href="http://blog.smallcpp.com/theme/images/favicon.ico" />
    <script src="http://blog.smallcpp.com/theme/js/modernizr.js"></script>
</head>

<body>

<!-- Nav Bar -->
<nav>
<div class="top-bar">
<div class="row">
    <div class="large-9 large-centered columns">
	    <h1><a href="http://blog.smallcpp.com">Small Cpp | 勿在浮沙筑高台, 练从难处练, 用从易处用.</a></h1>
    </div>
</div>
</div>

<!-- Show menu items and pages -->
<div class="row">
<div class="large-9 columns">
    <ul class="button-group navigation">

    </ul>
</div>
</div>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->
<div class="row">

    <!-- Main Blog Content -->
    <div class="large-9 columns">
<article>
    <header>
        <h3 class="article-title"><a href="http://blog.smallcpp.com/python-supervisor.html" rel="bookmark"
        title="Permalink to Python Supervisor">Python Supervisor</a></h3>
    </header>

<h6 class="subheader" title="2016-04-24T14:14:00+08:00">Sun 24 April 2016
</h6>


    <p>[TOC]</p>
<h1>1. Supervisor 介绍</h1>
<p>Supervisor 是用 Python 实现的一款非常实用的进程管理工具, Supervisor 会帮你把应用程序转成 Daemon 程序, 而且可以方便的通过命令开启、关闭、重启等操作, 托管给它管理的进程一旦崩溃也会自动重启, 这样就可以保证程序执行中断后的情况下有自我修复的功能.</p>
<p>注意事项:</p>
<ul>
<li>不支持任何版本的 <strong>Windows</strong></li>
<li>支持 Python 2.4 +, 但__不__支持 <strong>Python3</strong></li>
</ul>
<p>Supervisor <strong>特性</strong>:</p>
<ul>
<li>同时启动多个进程, 可以配置同时启动的进程数, 而不需要一个个启动</li>
<li>可以根据程序的退出码来判断是否需要自动重启</li>
<li>处理程序所产生的日志</li>
<li>提供管理进程(开始, 启动, 重启, 查看进程状态)的 web 界面, 和 xmlrpc 接口</li>
</ul>
<p>Supervisor 由两部分__构成__:</p>
<ul>
<li>supervisord: Supervisor 服务</li>
<li>supervisorctl: Supervisor 控制程序</li>
</ul>
<blockquote>
<p>简单的说就是先使用 <strong>supervisord</strong> 开始 Supervisor 服务, 然后通过 <strong>supervisorctl</strong> 管理 Supervisor 服务</p>
</blockquote>
<h1>2. 安装</h1>
<div class="highlight"><pre><span></span>pip install supervisor
</pre></div>


<p><br>
可以安装在系统级的 Python 环境下, 也可以安装在 virtualenv 级的 Python 环境下, 建议安装在系统级的 Python 环境, 这样就可以把 supervisor 配成开机启动, 而且 supervisor 也算是通用扩展了...</p>
<h1>3. 配置</h1>
<p>安装完成后, 使用下面这两种方式创建配置文件:</p>
<ul>
<li>创建一个全局配置文件 echo_supervisord_conf > /etc/supervisord.conf</li>
<li>在当前目录创建配置文件 echo_supervisord_conf > supervisord.conf, 然后使用 <strong>-c</strong> 参数在启动时手动指定配置文件: <code>supervisord -c supervisord.conf</code></li>
</ul>
<p>默认配置文件 echo_supervisord_conf 内容:</p>
<div class="highlight"><pre><span></span><span class="o">;</span> <span class="nt">Sample</span> <span class="nt">supervisor</span> <span class="nt">config</span> <span class="nt">file</span><span class="o">.</span>
<span class="o">;</span>
<span class="o">;</span> <span class="nt">For</span> <span class="nt">more</span> <span class="nt">information</span> <span class="nt">on</span> <span class="nt">the</span> <span class="nt">config</span> <span class="nt">file</span><span class="o">,</span> <span class="nt">please</span> <span class="nt">see</span><span class="o">:</span>
<span class="o">;</span> <span class="nt">http</span><span class="o">://</span><span class="nt">supervisord</span><span class="nc">.org</span><span class="o">/</span><span class="nt">configuration</span><span class="nc">.html</span>
<span class="o">;</span>
<span class="o">;</span> <span class="nt">Note</span><span class="o">:</span> <span class="nt">shell</span> <span class="nt">expansion</span> <span class="o">(</span><span class="s2">&quot;~&quot;</span> <span class="nt">or</span> <span class="s2">&quot;$HOME&quot;</span><span class="o">)</span> <span class="nt">is</span> <span class="nt">not</span> <span class="nt">supported</span><span class="o">.</span>  <span class="nt">Environment</span>
<span class="o">;</span> <span class="nt">variables</span> <span class="nt">can</span> <span class="nt">be</span> <span class="nt">expanded</span> <span class="nt">using</span> <span class="nt">this</span> <span class="nt">syntax</span><span class="o">:</span> <span class="s2">&quot;%(ENV_HOME)s&quot;</span><span class="o">.</span>

<span class="cp">[</span><span class="nx">unix_http_server</span><span class="cp">]</span>          <span class="o">;</span> <span class="nt">supervisord</span> <span class="err">的</span> <span class="nt">unix</span> <span class="nt">socket</span> <span class="err">服务配置</span>
<span class="nt">file</span><span class="o">=/</span><span class="nt">tmp</span><span class="o">/</span><span class="nt">supervisor</span><span class="nc">.sock</span>   <span class="o">;</span> <span class="nt">socket</span> <span class="err">文件的保存目录</span>
<span class="o">;</span><span class="nt">chmod</span><span class="o">=</span><span class="nt">0700</span>                 <span class="o">;</span> <span class="nt">socket</span> <span class="err">的文件权限</span> <span class="o">(</span><span class="nt">default</span> <span class="nt">0700</span><span class="o">)</span>
<span class="o">;</span><span class="nt">chown</span><span class="o">=</span><span class="nt">nobody</span><span class="nd">:nogroup</span>       <span class="o">;</span> <span class="nt">socket</span> <span class="err">的拥有者和组名</span>
<span class="o">;</span><span class="nt">username</span><span class="o">=</span><span class="nt">user</span>              <span class="o">;</span> <span class="err">默认不需要登陆用户</span> <span class="o">(</span><span class="nt">open</span> <span class="nt">server</span><span class="o">)</span>
<span class="o">;</span><span class="nt">password</span><span class="o">=</span><span class="nt">123</span>               <span class="o">;</span> <span class="err">默认不需要登陆密码</span> <span class="o">(</span><span class="nt">open</span> <span class="nt">server</span><span class="o">)</span>

<span class="o">;</span><span class="cp">[</span><span class="nx">inet_http_server</span><span class="cp">]</span>         <span class="o">;</span> <span class="nt">supervisord</span> <span class="err">的</span> <span class="nt">tcp</span> <span class="err">服务配置</span>
<span class="o">;</span><span class="nt">port</span><span class="o">=</span><span class="nt">127</span><span class="nc">.0.0.1</span><span class="nd">:9001</span>        <span class="o">;</span> <span class="nt">tcp</span> <span class="err">端口</span>
<span class="o">;</span><span class="nt">username</span><span class="o">=</span><span class="nt">user</span>              <span class="o">;</span> <span class="nt">tcp</span> <span class="err">登陆用户</span>
<span class="o">;</span><span class="nt">password</span><span class="o">=</span><span class="nt">123</span>               <span class="o">;</span> <span class="nt">tcp</span> <span class="err">登陆密码</span>

<span class="cp">[</span><span class="nx">supervisord</span><span class="cp">]</span>                <span class="o">;</span> <span class="nt">supervisord</span> <span class="err">的主进程配置</span>
<span class="nt">logfile</span><span class="o">=/</span><span class="nt">tmp</span><span class="o">/</span><span class="nt">supervisord</span><span class="nc">.log</span> <span class="o">;</span> <span class="err">主要的进程日志配置</span>
<span class="nt">logfile_maxbytes</span><span class="o">=</span><span class="nt">50MB</span>        <span class="o">;</span> <span class="err">最大日志体积</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">50MB</span>
<span class="nt">logfile_backups</span><span class="o">=</span><span class="nt">10</span>           <span class="o">;</span> <span class="err">日志文件备份数目</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">10</span>
<span class="nt">loglevel</span><span class="o">=</span><span class="nt">info</span>                <span class="o">;</span> <span class="err">日志级别</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">info</span><span class="o">;</span> <span class="err">还有</span><span class="o">:</span> <span class="nt">debug</span><span class="o">,</span> <span class="nt">warn</span><span class="o">,</span> <span class="nt">trace</span>
<span class="nt">pidfile</span><span class="o">=/</span><span class="nt">tmp</span><span class="o">/</span><span class="nt">supervisord</span><span class="nc">.pid</span> <span class="o">;</span> <span class="nt">supervisord</span> <span class="err">的</span> <span class="nt">pidfile</span> <span class="err">文件</span>
<span class="nt">nodaemon</span><span class="o">=</span><span class="nt">false</span>               <span class="o">;</span> <span class="err">是否以守护进程的方式启动</span>
<span class="nt">minfds</span><span class="o">=</span><span class="nt">1024</span>                  <span class="o">;</span> <span class="err">最小的有效文件描述符</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">1024</span>
<span class="nt">minprocs</span><span class="o">=</span><span class="nt">200</span>                 <span class="o">;</span> <span class="err">最小的有效进程描述符</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">200</span>
<span class="o">;</span><span class="nt">umask</span><span class="o">=</span><span class="nt">022</span>                   <span class="o">;</span> <span class="err">进程文件的</span> <span class="nt">umask</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">200</span>
<span class="o">;</span><span class="nt">user</span><span class="o">=</span><span class="nt">chrism</span>                 <span class="o">;</span> <span class="err">默认为当前用户</span><span class="o">,</span> <span class="err">如果为</span> <span class="nt">root</span> <span class="err">则必填</span>
<span class="o">;</span><span class="nt">identifier</span><span class="o">=</span><span class="nt">supervisor</span>       <span class="o">;</span> <span class="nt">supervisord</span> <span class="err">的表示符</span><span class="o">,</span> <span class="err">默认时</span> <span class="s1">&#39;supervisor&#39;</span>
<span class="o">;</span><span class="nt">directory</span><span class="o">=/</span><span class="nt">tmp</span>              <span class="o">;</span> <span class="err">在运行前</span> <span class="nt">cwd</span> <span class="err">到指定的目录</span><span class="o">,</span> <span class="err">默认不执行</span> <span class="nt">cmd</span>
<span class="o">;</span><span class="nt">nocleanup</span><span class="o">=</span><span class="nt">true</span>              <span class="o">;</span> <span class="err">不在启动的时候清除临时文件</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">false</span>
<span class="o">;</span><span class="nt">childlogdir</span><span class="o">=/</span><span class="nt">tmp</span>            <span class="o">;</span> <span class="o">(</span><span class="s1">&#39;AUTO&#39;</span> <span class="nt">child</span> <span class="nt">log</span> <span class="nt">dir</span><span class="o">,</span> <span class="nt">default</span> <span class="o">$</span><span class="nt">TEMP</span><span class="o">)</span>
<span class="o">;</span><span class="nt">environment</span><span class="o">=</span><span class="nt">KEY</span><span class="o">=</span><span class="nt">value</span>       <span class="o">;</span> <span class="err">初始键值对传递给进程</span>
<span class="o">;</span><span class="nt">strip_ansi</span><span class="o">=</span><span class="nt">false</span>            <span class="o">;</span> <span class="o">(</span><span class="nt">strip</span> <span class="nt">ansi</span> <span class="nt">escape</span> <span class="nt">codes</span> <span class="nt">in</span> <span class="nt">logs</span><span class="o">;</span> <span class="nt">def</span><span class="o">.</span> <span class="nt">false</span><span class="o">)</span>

<span class="o">;</span> <span class="nt">the</span> <span class="nt">below</span> <span class="nt">section</span> <span class="nt">must</span> <span class="nt">remain</span> <span class="nt">in</span> <span class="nt">the</span> <span class="nt">config</span> <span class="nt">file</span> <span class="nt">for</span> <span class="nt">RPC</span>
<span class="o">;</span> <span class="o">(</span><span class="nt">supervisorctl</span><span class="o">/</span><span class="nt">web</span> <span class="nt">interface</span><span class="o">)</span> <span class="nt">to</span> <span class="nt">work</span><span class="o">,</span> <span class="nt">additional</span> <span class="nt">interfaces</span> <span class="nt">may</span> <span class="nt">be</span>
<span class="o">;</span> <span class="nt">added</span> <span class="nt">by</span> <span class="nt">defining</span> <span class="nt">them</span> <span class="nt">in</span> <span class="nt">separate</span> <span class="nt">rpcinterface</span><span class="o">:</span> <span class="nt">sections</span>
<span class="cp">[</span><span class="nx">rpcinterface</span><span class="p">:</span><span class="nx">supervisor</span><span class="cp">]</span>
<span class="nt">supervisor</span><span class="nc">.rpcinterface_factory</span> <span class="o">=</span> <span class="nt">supervisor</span><span class="nc">.rpcinterface</span><span class="nd">:make_main_rpcinterface</span>

<span class="cp">[</span><span class="nx">supervisorctl</span><span class="cp">]</span>
<span class="nt">serverurl</span><span class="o">=</span><span class="nt">unix</span><span class="o">:///</span><span class="nt">tmp</span><span class="o">/</span><span class="nt">supervisor</span><span class="nc">.sock</span> <span class="o">;</span> <span class="nt">use</span> <span class="nt">a</span> <span class="nt">unix</span><span class="o">://</span> <span class="nt">URL</span>  <span class="nt">for</span> <span class="nt">a</span> <span class="nt">unix</span> <span class="nt">socket</span>
<span class="o">;</span><span class="nt">serverurl</span><span class="o">=</span><span class="nt">http</span><span class="o">://</span><span class="nt">127</span><span class="nc">.0.0.1</span><span class="nd">:9001</span> <span class="o">;</span> <span class="nt">use</span> <span class="nt">an</span> <span class="nt">http</span><span class="o">://</span> <span class="nt">url</span> <span class="nt">to</span> <span class="nt">specify</span> <span class="nt">an</span> <span class="nt">inet</span> <span class="nt">socket</span>
<span class="o">;</span><span class="nt">username</span><span class="o">=</span><span class="nt">chris</span>              <span class="o">;</span> <span class="err">如果设置应该与</span> <span class="nt">http_username</span> <span class="err">相同</span>
<span class="o">;</span><span class="nt">password</span><span class="o">=</span><span class="nt">123</span>                <span class="o">;</span> <span class="err">如果设置应该与</span> <span class="nt">http_password</span> <span class="err">相同</span>
<span class="o">;</span><span class="nt">prompt</span><span class="o">=</span><span class="nt">mysupervisor</span>         <span class="o">;</span> <span class="err">命令行提示符</span><span class="o">,</span> <span class="err">默认</span> <span class="s1">&#39;supervisor&#39;</span>
<span class="o">;</span><span class="nt">history_file</span><span class="o">=~/</span><span class="nc">.sc_history</span>  <span class="o">;</span> <span class="err">命令行历史纪录</span>

<span class="o">;</span> <span class="nt">The</span> <span class="nt">below</span> <span class="nt">sample</span> <span class="nt">program</span> <span class="nt">section</span> <span class="nt">shows</span> <span class="nt">all</span> <span class="nt">possible</span> <span class="nt">program</span> <span class="nt">subsection</span> <span class="nt">values</span><span class="o">,</span>
<span class="o">;</span> <span class="nt">create</span> <span class="nt">one</span> <span class="nt">or</span> <span class="nt">more</span> <span class="s1">&#39;real&#39;</span> <span class="nt">program</span><span class="o">:</span> <span class="nt">sections</span> <span class="nt">to</span> <span class="nt">be</span> <span class="nt">able</span> <span class="nt">to</span> <span class="nt">control</span> <span class="nt">them</span> <span class="nt">under</span>
<span class="o">;</span> <span class="nt">supervisor</span><span class="o">.</span>

<span class="o">;</span><span class="cp">[</span><span class="nx">program</span><span class="p">:</span><span class="nx">theprogramname</span><span class="cp">]</span>
<span class="o">;</span><span class="nt">command</span><span class="o">=/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">cat</span>              <span class="o">;</span> <span class="err">运行的程序</span> <span class="o">(</span><span class="err">相对使用</span><span class="nt">PATH</span><span class="err">路径</span><span class="o">,</span> <span class="err">可以使用参数</span><span class="o">)</span>
<span class="o">;</span><span class="nt">process_name</span><span class="o">=%(</span><span class="nt">program_name</span><span class="o">)</span><span class="nt">s</span> <span class="o">;</span> <span class="err">进程名表达式</span><span class="o">,</span> <span class="err">默认为</span> <span class="o">%(</span><span class="nt">program_name</span><span class="o">)</span><span class="nt">s</span>
<span class="o">;</span><span class="nt">numprocs</span><span class="o">=</span><span class="nt">1</span>                    <span class="o">;</span> <span class="err">默认启动的进程数目</span><span class="o">,</span> <span class="err">默认为</span> <span class="nt">1</span>
<span class="o">;</span><span class="nt">directory</span><span class="o">=/</span><span class="nt">tmp</span>                <span class="o">;</span> <span class="err">在运行前</span> <span class="nt">cwd</span> <span class="err">到指定的目录</span><span class="o">,</span> <span class="err">默认不执行</span> <span class="nt">cmd</span>
<span class="o">;</span><span class="nt">umask</span><span class="o">=</span><span class="nt">022</span>                     <span class="o">;</span> <span class="err">进程</span> <span class="nt">umask</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">None</span>
<span class="o">;</span><span class="nt">priority</span><span class="o">=</span><span class="nt">999</span>                  <span class="o">;</span> <span class="err">程序运行的优先级</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">999</span>
<span class="o">;</span><span class="nt">autostart</span><span class="o">=</span><span class="nt">true</span>                <span class="o">;</span> <span class="err">默认随</span> <span class="nt">supervisord</span> <span class="err">自动启动</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">true</span>
<span class="o">;</span><span class="nt">autorestart</span><span class="o">=</span><span class="nt">unexpected</span>        <span class="o">;</span> <span class="err">被监控程序异常中断是否自动重启</span>
<span class="o">;</span><span class="nt">startsecs</span><span class="o">=</span><span class="nt">1</span>                   <span class="o">;</span> <span class="err">被监控程序启动时持续时间</span> <span class="o">(</span><span class="nt">def</span><span class="o">.</span> <span class="nt">1</span><span class="o">)</span>
<span class="o">;</span><span class="nt">startretries</span><span class="o">=</span><span class="nt">3</span>                <span class="o">;</span> <span class="err">被监控程序启动失败重试的次数</span> <span class="o">(</span><span class="nt">default</span> <span class="nt">3</span><span class="o">)</span>
<span class="o">;</span><span class="nt">exitcodes</span><span class="o">=</span><span class="nt">0</span><span class="o">,</span><span class="nt">2</span>                 <span class="o">;</span> <span class="err">期望的退出码</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">0</span><span class="o">,</span> <span class="nt">2</span>
<span class="o">;</span><span class="nt">stopsignal</span><span class="o">=</span><span class="nt">QUIT</span>               <span class="o">;</span> <span class="err">杀死进程的信号</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">TERM</span>
<span class="o">;</span><span class="nt">stopwaitsecs</span><span class="o">=</span><span class="nt">10</span>               <span class="o">;</span> <span class="nt">max</span> <span class="nt">num</span> <span class="nt">secs</span> <span class="nt">to</span> <span class="nt">wait</span> <span class="nt">b4</span> <span class="nt">SIGKILL</span> <span class="o">(</span><span class="nt">default</span> <span class="nt">10</span><span class="o">)</span>
<span class="o">;</span><span class="nt">stopasgroup</span><span class="o">=</span><span class="nt">false</span>             <span class="o">;</span> <span class="err">向</span> <span class="nt">unix</span> <span class="err">进程组发送停止信号</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">false</span>
<span class="o">;</span><span class="nt">killasgroup</span><span class="o">=</span><span class="nt">false</span>             <span class="o">;</span> <span class="err">向</span> <span class="nt">unix</span> <span class="err">进程组发送</span><span class="nt">SIGKILL</span><span class="err">信号</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">false</span>
<span class="o">;</span><span class="nt">user</span><span class="o">=</span><span class="nt">chrism</span>                   <span class="o">;</span> <span class="err">为运行程序的</span> <span class="nt">unix</span> <span class="err">帐号设置</span> <span class="nt">setuid</span>
<span class="o">;</span><span class="nt">redirect_stderr</span><span class="o">=</span><span class="nt">true</span>          <span class="o">;</span> <span class="err">将标准错误重定向到标准输出</span><span class="o">,</span> <span class="err">默认</span> <span class="nt">false</span>
<span class="o">;</span><span class="nt">stdout_logfile</span><span class="o">=/</span><span class="nt">a</span><span class="o">/</span><span class="nt">path</span>        <span class="o">;</span> <span class="err">标准输出的文件路径</span> <span class="nt">NONE</span><span class="err">＝</span><span class="nt">none</span><span class="o">;</span> <span class="err">默认</span> <span class="nt">AUTO</span>
<span class="o">;</span><span class="nt">stdout_logfile_maxbytes</span><span class="o">=</span><span class="nt">1MB</span>   <span class="o">;</span> <span class="nt">max</span> <span class="err">#</span> <span class="nt">logfile</span> <span class="nt">bytes</span> <span class="nt">b4</span> <span class="nt">rotation</span> <span class="o">(</span><span class="nt">default</span> <span class="nt">50MB</span><span class="o">)</span>
<span class="o">;</span><span class="nt">stdout_logfile_backups</span><span class="o">=</span><span class="nt">10</span>     <span class="o">;</span> <span class="err">#</span> <span class="nt">of</span> <span class="nt">stdout</span> <span class="nt">logfile</span> <span class="nt">backups</span> <span class="o">(</span><span class="nt">default</span> <span class="nt">10</span><span class="o">)</span>
<span class="o">;</span><span class="nt">stdout_capture_maxbytes</span><span class="o">=</span><span class="nt">1MB</span>   <span class="o">;</span> <span class="nt">number</span> <span class="nt">of</span> <span class="nt">bytes</span> <span class="nt">in</span> <span class="s1">&#39;capturemode&#39;</span> <span class="o">(</span><span class="nt">default</span> <span class="nt">0</span><span class="o">)</span>
<span class="o">;</span><span class="nt">stdout_events_enabled</span><span class="o">=</span><span class="nt">false</span>   <span class="o">;</span> <span class="nt">emit</span> <span class="nt">events</span> <span class="nt">on</span> <span class="nt">stdout</span> <span class="nt">writes</span> <span class="o">(</span><span class="nt">default</span> <span class="nt">false</span><span class="o">)</span>
<span class="o">;</span><span class="nt">stderr_logfile</span><span class="o">=/</span><span class="nt">a</span><span class="o">/</span><span class="nt">path</span>        <span class="o">;</span> <span class="nt">stderr</span> <span class="nt">log</span> <span class="nt">path</span><span class="o">,</span> <span class="nt">NONE</span> <span class="nt">for</span> <span class="nt">none</span><span class="o">;</span> <span class="nt">default</span> <span class="nt">AUTO</span>
<span class="o">;</span><span class="nt">stderr_logfile_maxbytes</span><span class="o">=</span><span class="nt">1MB</span>   <span class="o">;</span> <span class="nt">max</span> <span class="err">#</span> <span class="nt">logfile</span> <span class="nt">bytes</span> <span class="nt">b4</span> <span class="nt">rotation</span> <span class="o">(</span><span class="nt">default</span> <span class="nt">50MB</span><span class="o">)</span>
<span class="o">;</span><span class="nt">stderr_logfile_backups</span><span class="o">=</span><span class="nt">10</span>     <span class="o">;</span> <span class="err">#</span> <span class="nt">of</span> <span class="nt">stderr</span> <span class="nt">logfile</span> <span class="nt">backups</span> <span class="o">(</span><span class="nt">default</span> <span class="nt">10</span><span class="o">)</span>
<span class="o">;</span><span class="nt">stderr_capture_maxbytes</span><span class="o">=</span><span class="nt">1MB</span>   <span class="o">;</span> <span class="nt">number</span> <span class="nt">of</span> <span class="nt">bytes</span> <span class="nt">in</span> <span class="s1">&#39;capturemode&#39;</span> <span class="o">(</span><span class="nt">default</span> <span class="nt">0</span><span class="o">)</span>
<span class="o">;</span><span class="nt">stderr_events_enabled</span><span class="o">=</span><span class="nt">false</span>   <span class="o">;</span> <span class="nt">emit</span> <span class="nt">events</span> <span class="nt">on</span> <span class="nt">stderr</span> <span class="nt">writes</span> <span class="o">(</span><span class="nt">default</span> <span class="nt">false</span><span class="o">)</span>
<span class="o">;</span><span class="nt">environment</span><span class="o">=</span><span class="nt">A</span><span class="o">=</span><span class="nt">1</span><span class="o">,</span><span class="nt">B</span><span class="o">=</span><span class="nt">2</span>           <span class="o">;</span> <span class="nt">process</span> <span class="nt">environment</span> <span class="nt">additions</span> <span class="o">(</span><span class="nt">def</span> <span class="nt">no</span> <span class="nt">adds</span><span class="o">)</span>
<span class="o">;</span><span class="nt">serverurl</span><span class="o">=</span><span class="nt">AUTO</span>                <span class="o">;</span> <span class="nt">override</span> <span class="nt">serverurl</span> <span class="nt">computation</span> <span class="o">(</span><span class="nt">childutils</span><span class="o">)</span>

<span class="o">;</span> <span class="nt">The</span> <span class="nt">below</span> <span class="nt">sample</span> <span class="nt">eventlistener</span> <span class="nt">section</span> <span class="nt">shows</span> <span class="nt">all</span> <span class="nt">possible</span>
<span class="o">;</span> <span class="nt">eventlistener</span> <span class="nt">subsection</span> <span class="nt">values</span><span class="o">,</span> <span class="nt">create</span> <span class="nt">one</span> <span class="nt">or</span> <span class="nt">more</span> <span class="s1">&#39;real&#39;</span>
<span class="o">;</span> <span class="nt">eventlistener</span><span class="o">:</span> <span class="nt">sections</span> <span class="nt">to</span> <span class="nt">be</span> <span class="nt">able</span> <span class="nt">to</span> <span class="nt">handle</span> <span class="nt">event</span> <span class="nt">notifications</span>
<span class="o">;</span> <span class="nt">sent</span> <span class="nt">by</span> <span class="nt">supervisor</span><span class="o">.</span>

<span class="o">;</span><span class="cp">[</span><span class="nx">eventlistener</span><span class="p">:</span><span class="nx">theeventlistenername</span><span class="cp">]</span>
<span class="o">;</span><span class="nt">command</span><span class="o">=/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">eventlistener</span>    <span class="o">;</span> <span class="err">运行的程序</span> <span class="o">(</span><span class="err">相对使用</span> <span class="nt">PATH</span> <span class="err">路径</span><span class="o">,</span> <span class="err">可以使用参数</span><span class="o">)</span>
<span class="o">;</span><span class="nt">process_name</span><span class="o">=%(</span><span class="nt">program_name</span><span class="o">)</span><span class="nt">s</span> <span class="o">;</span> <span class="err">进程名表达式</span><span class="o">,</span> <span class="err">默认为</span> <span class="o">%(</span><span class="nt">program_name</span><span class="o">)</span><span class="nt">s</span>
<span class="o">;</span><span class="nt">numprocs</span><span class="o">=</span><span class="nt">1</span>                    <span class="o">;</span> <span class="err">默认启动的进程数目</span><span class="o">,</span> <span class="err">默认为</span> <span class="nt">1</span>
<span class="o">;</span><span class="nt">events</span><span class="o">=</span><span class="nt">EVENT</span>                  <span class="o">;</span> <span class="nt">event</span> <span class="nt">notif</span><span class="o">.</span> <span class="nt">types</span> <span class="nt">to</span> <span class="nt">subscribe</span> <span class="nt">to</span> <span class="o">(</span><span class="nt">req</span><span class="s1">&#39;d)</span>
<span class="s1">;buffer_size=10                ; 事件缓冲区队列大小, 默认 10</span>
<span class="s1">;directory=/tmp                ; 在运行前 cwd 到指定的目录, 默认不执行 cmd</span>
<span class="s1">;umask=022                     ; 进程umask, 默认 None</span>
<span class="s1">;priority=-1                   ; 程序运行的优先级, 默认 -1</span>
<span class="s1">;autostart=true                ; 默认随supervisord自动启动, 默认true</span>
<span class="s1">;autorestart=unexpected        ; whether/when to restart (default: unexpected)</span>
<span class="s1">;startsecs=1                   ; number of secs prog must stay running (def. 1)</span>
<span class="s1">;startretries=3                ; max # of serial start failures (default 3)</span>
<span class="s1">;exitcodes=0,2                 ; 期望的退出码, 默认 0,2</span>
<span class="s1">;stopsignal=QUIT               ; 杀死进程的信号, 默认 TERM</span>
<span class="s1">;stopwaitsecs=10               ; max num secs to wait b4 SIGKILL (default 10)</span>
<span class="s1">;stopasgroup=false             ; 向unix进程组发送停止信号, 默认false</span>
<span class="s1">;killasgroup=false             ; 向unix进程组发送SIGKILL信号, 默认false</span>
<span class="s1">;user=chrism                   ; setuid to this UNIX account to run the program</span>
<span class="s1">;redirect_stderr=true          ; redirect proc stderr to stdout (default false)</span>
<span class="s1">;stdout_logfile=/a/path        ; stdout log path, NONE for none; default AUTO</span>
<span class="s1">;stdout_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)</span>
<span class="s1">;stdout_logfile_backups=10     ; # of stdout logfile backups (default 10)</span>
<span class="s1">;stdout_events_enabled=false   ; emit events on stdout writes (default false)</span>
<span class="s1">;stderr_logfile=/a/path        ; stderr log path, NONE for none; default AUTO</span>
<span class="s1">;stderr_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)</span>
<span class="s1">;stderr_logfile_backups        ; # of stderr logfile backups (default 10)</span>
<span class="s1">;stderr_events_enabled=false   ; emit events on stderr writes (default false)</span>
<span class="s1">;environment=A=1,B=2           ; process environment additions</span>
<span class="s1">;serverurl=AUTO                ; override serverurl computation (childutils)</span>

<span class="s1">; The below sample group section shows all possible group values,</span>
<span class="s1">; create one or more &#39;</span><span class="nt">real</span><span class="err">&#39;</span> <span class="nt">group</span><span class="o">:</span> <span class="nt">sections</span> <span class="nt">to</span> <span class="nt">create</span> <span class="s2">&quot;heterogeneous&quot;</span>
<span class="o">;</span> <span class="nt">process</span> <span class="nt">groups</span><span class="o">.</span>

<span class="o">;</span><span class="cp">[</span><span class="k">group</span><span class="p">:</span><span class="nx">thegroupname</span><span class="cp">]</span>
<span class="o">;</span><span class="nt">programs</span><span class="o">=</span><span class="nt">progname1</span><span class="o">,</span><span class="nt">progname2</span>  <span class="o">;</span> <span class="err">任何在</span><span class="cp">[</span><span class="nx">program</span><span class="p">:</span><span class="nx">x</span><span class="cp">]</span><span class="err">中定义的</span><span class="nt">x</span>
<span class="o">;</span><span class="nt">priority</span><span class="o">=</span><span class="nt">999</span>                  <span class="o">;</span> <span class="err">程序运行的优先级</span><span class="o">,</span> <span class="err">默认</span><span class="nt">999</span>

<span class="o">;</span> <span class="nt">The</span> <span class="cp">[</span><span class="nb">include</span><span class="cp">]</span> <span class="nt">section</span> <span class="nt">can</span> <span class="nt">just</span> <span class="nt">contain</span> <span class="nt">the</span> <span class="s2">&quot;files&quot;</span> <span class="nt">setting</span><span class="o">.</span>  <span class="nt">This</span>
<span class="o">;</span> <span class="nt">setting</span> <span class="nt">can</span> <span class="nt">list</span> <span class="nt">multiple</span> <span class="nt">files</span> <span class="o">(</span><span class="nt">separated</span> <span class="nt">by</span> <span class="nt">whitespace</span> <span class="nt">or</span>
<span class="o">;</span> <span class="nt">newlines</span><span class="o">).</span>  <span class="nt">It</span> <span class="nt">can</span> <span class="nt">also</span> <span class="nt">contain</span> <span class="nt">wildcards</span><span class="o">.</span>  <span class="nt">The</span> <span class="nt">filenames</span> <span class="nt">are</span>
<span class="o">;</span> <span class="nt">interpreted</span> <span class="nt">as</span> <span class="nt">relative</span> <span class="nt">to</span> <span class="nt">this</span> <span class="nt">file</span><span class="o">.</span>  <span class="nt">Included</span> <span class="nt">files</span> <span class="o">*</span><span class="nt">cannot</span><span class="o">*</span>
<span class="o">;</span> <span class="nt">include</span> <span class="nt">files</span> <span class="nt">themselves</span><span class="o">.</span>

<span class="o">;</span><span class="cp">[</span><span class="nb">include</span><span class="cp">]</span>
<span class="o">;</span><span class="nt">files</span> <span class="o">=</span> <span class="nt">relative</span><span class="o">/</span><span class="nt">directory</span><span class="o">/*</span><span class="nc">.ini</span>
</pre></div>


<p><br></p>
<h1>4. 添加一个程序</h1>
<p>编辑配置文件 supervisord.conf, 在后面添加新程序:</p>
<div class="highlight"><pre><span></span><span class="k">[program:test_py]</span>
<span class="na">command</span><span class="o">=</span><span class="s">python /etc/my_pro/test.py</span>
<span class="na">autorestart</span><span class="o">=</span><span class="s">true</span>
<span class="na">directory</span><span class="o">=</span><span class="s">/etc/my_pro</span>
<span class="na">stdout_logfile</span><span class="o">=</span><span class="s">/etc/my_pro/test_stdout.log</span>
<span class="na">stderr_logfile</span><span class="o">=</span><span class="s">/etc/my_pro/test_stderr.log</span>
</pre></div>


<p><br></p>
<blockquote>
<p>后来发现在 python 中使用 print 时, test_stdout.log 文件里不输出内容, 原来 print 是输出到缓冲区, 在满足某些条件下才会从缓冲区写出, 使用 <strong>-u</strong> 参数来停用缓冲区, 直接写文件: <code>python -u /etc/my_pro/test.py</code></p>
</blockquote>
<p><strong>注意!!</strong><br>
如果配置中的 command 是执行一个 bash, 然后在 bash 里执行了 python 脚本, 那么当使用 supervisor 停止程序时, 只有上层进程被停止(即 bash 被停止了), 但 python 进程没有被停止.</p>
<p>解决办法:<br>
在配置文件中设置:</p>
<div class="highlight"><pre><span></span>stopasgroup=true
killasgroup=true
</pre></div>


<p><br></p>
<h1>5. 使用 supervisor 管理程序</h1>
<ul>
<li>使用指定配置文件启动: supervisord -c supervisord.conf</li>
<li>使用默认配置文件启动: supervisord</li>
</ul>
<p>常用命令:<br>
控制命令基本都通过 supervisorctl 执行, 输入 help 可以看到命令列表, 这是一些常用命令:</p>
<ul>
<li>得到所有程序状态 supervisorctl status</li>
<li>关闭目标程序 supervisorctl stop spider</li>
<li>启动目标程序 supervisorctl start spider</li>
<li>关闭所有程序 supervisorctl shutdown</li>
<li>重载配置文件 supervisorctl reload</li>
</ul>
<blockquote>
<p>可以先键入 supervisorctl 进入交互状态, 再使用 status、start 等命令.</p>
</blockquote>
<h1>6. 通过 web 方式查看状态</h1>
<p>配置文件中配置:</p>
<div class="highlight"><pre><span></span><span class="cp">[</span><span class="nx">inet_http_server</span><span class="cp">]</span>         <span class="o">;</span> <span class="nt">inet</span> <span class="o">(</span><span class="nt">TCP</span><span class="o">)</span> <span class="nt">server</span> <span class="nt">disabled</span> <span class="nt">by</span> <span class="nt">default</span>
<span class="nt">port</span><span class="o">=</span><span class="nt">127</span><span class="nc">.0.0.1</span><span class="nd">:9001</span>        <span class="o">;</span> <span class="o">(</span><span class="nt">ip_address</span><span class="nd">:port</span> <span class="nt">specifier</span><span class="o">,</span> <span class="o">*</span><span class="nd">:port</span> <span class="nt">for</span> <span class="nt">all</span> <span class="nt">iface</span><span class="o">)</span>
</pre></div>


<p><br>
那么可以从浏览器通过访问 <code>127.0.0.1:9001</code> 来查看进程状态</p>
<p class="subheader">Category: <a href="http://blog.smallcpp.com/category/python.html">Python</a>

</p>




<!--      -->

    <!-- 多说评论框 start -->
    <h4>Comments !</h4>
    <div class="ds-thread" data-thread-key="python-supervisor" data-title="Python Supervisor" data-url="http://blog.smallcpp.com/python-supervisor.html"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
        var duoshuoQuery = {short_name:"smallcpp"};
            (function() {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';ds.async = true;
                ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
    </script>
    <!-- 多说公共JS代码 end -->
</article>
    </div>
    <!-- End Main Content -->

    <!-- Sidebar -->
    <aside class="large-3 columns">
        <h5 class="sidebar-title">Site</h5>
        <ul class="side-nav">
            <li><a href="http://blog.smallcpp.com/archives.html">Archives</a>
            <li><a href="http://blog.smallcpp.com/tags.html">Tags</a>
        </ul>

        <h5 class="sidebar-title">Categories</h5>
        <ul class="side-nav">
            <li><a href="http://blog.smallcpp.com/category/c11.html">C++11</a></li>
            <li><a href="http://blog.smallcpp.com/category/cocos2d.html">Cocos2d</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-hua-she-ji-mo-shi.html">大话设计模式</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-shu-ju.html">大数据</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-shu-ju-java-ji-chu.html">大数据 Java 基础</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-shu-ju-linux-ji-chu.html">大数据 Linux 基础</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-shu-ju-mongodb-ji-chu.html">大数据 Mongodb 基础</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-shu-ju-redis-ji-chu.html">大数据 Redis 基础</a></li>
            <li><a href="http://blog.smallcpp.com/category/du-shu-bi-ji.html">读书笔记</a></li>
            <li><a href="http://blog.smallcpp.com/category/golang.html">Golang</a></li>
            <li><a href="http://blog.smallcpp.com/category/hei-ke-ji.html">黑科技</a></li>
            <li><a href="http://blog.smallcpp.com/category/java.html">JAVA</a></li>
            <li><a href="http://blog.smallcpp.com/category/lua.html">Lua</a></li>
            <li><a href="http://blog.smallcpp.com/category/pyqt.html">PyQt</a></li>
            <li><a href="http://blog.smallcpp.com/category/python.html">Python</a></li>
            <li><a href="http://blog.smallcpp.com/category/qt.html">QT</a></li>
            <li><a href="http://blog.smallcpp.com/category/ruan-jian-she-ji.html">软件设计</a></li>
            <li><a href="http://blog.smallcpp.com/category/za-xiang.html">杂项</a></li>
        </ul>

        <h5 class="sidebar-title">Links</h5>
        <ul class="side-nav">
            <li><a href="http://blog.csdn.net/u010850265">CSDN</a></li>
        </ul>

        <h5 class="sidebar-title">Social</h5>
        <ul class="side-nav">
            <li><a href="http://blog.csdn.net/u010850265">CSDN</a></li>
        </ul>

    </aside> <!-- End Sidebar -->

</div> <!-- End Main Content and Sidebar -->


<!-- Footer -->
<footer class="row">
    <div class="large-12 columns">
        <hr />
        <div class="row">
            <div class="large-6 columns">
              <!--                  <p>Small Cpp | 勿在浮沙筑高台, 练从难处练, 用从易处用. by martin</p> -->
            </div>
            </div>
    </div>
</footer>
</body>
</html>