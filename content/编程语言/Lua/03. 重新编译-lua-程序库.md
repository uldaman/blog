author: Martin
date: 2015-03-15 11:29
title: 03. 重新编译 Lua 程序库

通过上二篇的介绍, 已经可以在 C/C++ 程序中简单的使用 Lua 脚本, 然而那只是简单地在 VC 程序中直接访问 Lua API.
对于小项目来说这是可以的, 但更好的方式是抽象出简单的 Lua 程序库, 让它整合 C/C++ 和 Lua API 代码, 让其可以复用在多个项目中.
不是有首程序员版的<双截棍>吗, 里面有句歌词是这样的: **一个优秀的库函数, 一用好多年, 拷贝好带身边**.
接下来就开始创建这个程序库.

同第一篇一样, 采用 VS2013 + lua-5.2.4 来进行编译, 先去 Lua 官网下载 Lua 源码: [http://www.lua.org](http://www.lua.org)
然后修改源码, 使 Lua 支持中文的变量名及函数名.
接下来打开 VS2013 新建一个 win32 静态链接库 程序, 取名为 LuaLib, 不要勾选预编译头.
将 src 整个文件夹复制到工作目录下(注意这里是连 src 文件夹一起复制的, 第一篇中是复制的源码), 然后在刚新建的工程中添加**除 luac.c 和 lua.c 外**的其他源代码文件.

![](http://i62.tinypic.com/6r0n79.jpg)

打开属性编辑框, 在工程的预处理器设置中添加一行 _CRT_SECURE_NO_WARNINGS, 并且设置当前工程的包含目录.

![](http://i62.tinypic.com/b8nv55.jpg)

![](http://i58.tinypic.com/awauy1.jpg)

将下来为工程创建一个 CLua 类([源码传送门](https://github.com/z351522453/LuaLib)), 该类封装了一部分 Lua API 函数, 隐藏了 Lua 需要的初始化和关闭处理, 它的使用说明及源码分析将在后面进一步说明.

好, 接下来就开始编译 LuaLib 工程的 Debug 和 Release 版本, 将生成的 .lib 文件分别命名为 LuaLib_Debug.lib 和 LuaLib_Release.lib.

现在把 CLua.h 单独复制出来, 在文件开头添加如下代码:





    <span style="color: #000000;">#ifdef _DEBUG
    </span><span style="color: #0000ff;">#pragma</span> comment(lib,"LuaLib_Debug.lib")
    <span style="color: #0000ff;">#else</span>
    <span style="color: #0000ff;">#pragma</span> comment(lib,"LuaLib_Release.lib")
    <span style="color: #0000ff;">#endif</span>







好, 现在的 CLua.h 中的代码如下:





    <span style="color: #0000ff;">#pragma</span> once<span style="color: #000000;">

    #ifdef _DEBUG
    </span><span style="color: #0000ff;">#pragma</span> comment(lib,"LuaLib_Debug.lib")
    <span style="color: #0000ff;">#else</span>
    <span style="color: #0000ff;">#pragma</span> comment(lib,"LuaLib_Release.lib")
    <span style="color: #0000ff;">#endif</span>

    <span style="color: #0000ff;">struct</span><span style="color: #000000;"> lua_State;

    </span><span style="color: #0000ff;">#define</span> LuaGlue extern "C" int  <span style="color: #008000;">//</span><span style="color: #008000;"> 定义 LuaGlue 宏</span>

    <span style="color: #0000ff;">extern</span> <span style="color: #800000;">"</span><span style="color: #800000;">C</span><span style="color: #800000;">"</span> { <span style="color: #008000;">//</span><span style="color: #008000;"> 定义一个 C 方式的 LuaFunctionType 类型函数指针</span>
        typedef <span style="color: #0000ff;">int</span>(*LuaFunctionType)(lua_State *<span style="color: #000000;">pLuaState);
    };

    </span><span style="color: #0000ff;">class</span><span style="color: #000000;"> cLua {
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;">:
        cLua();
        </span><span style="color: #0000ff;">virtual</span> ~<span style="color: #000000;">cLua();

        </span><span style="color: #0000ff;">bool</span>        RunScript(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>*<span style="color: #000000;"> pFilename);
        </span><span style="color: #0000ff;">bool</span>        RunString(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>*<span style="color: #000000;"> pCommand);
        </span><span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>* GetErrorString(<span style="color: #0000ff;">void</span><span style="color: #000000;">);

        </span><span style="color: #0000ff;">bool</span>        AddFunction(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>*<span style="color: #000000;"> pFunctionName, LuaFunctionType pFunction);

        </span><span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>* GetStringArgument(<span style="color: #0000ff;">int</span> num, <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>* pDefault =<span style="color: #000000;"> NULL);
        </span><span style="color: #0000ff;">double</span>        GetNumberArgument(<span style="color: #0000ff;">int</span> num, <span style="color: #0000ff;">double</span> dDefault = <span style="color: #800080;">0.0</span><span style="color: #000000;">);
        </span><span style="color: #0000ff;">int</span>         GetIntArgument(<span style="color: #0000ff;">int</span> num, <span style="color: #0000ff;">int</span> nDefault = <span style="color: #800080;">0</span><span style="color: #000000;">);

        </span><span style="color: #0000ff;">void</span>        PushString(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>*<span style="color: #000000;"> pString);
        </span><span style="color: #0000ff;">void</span>        PushNumber(<span style="color: #0000ff;">double</span><span style="color: #000000;"> value);
        </span><span style="color: #0000ff;">void</span>        PushInt(<span style="color: #0000ff;">int</span><span style="color: #000000;"> value);

        </span><span style="color: #0000ff;">void</span>        SetErrorHandler(<span style="color: #0000ff;">void</span>(*pErrHandler)(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>*<span style="color: #000000;"> pError));

        lua_State</span>*  GetScriptContext(<span style="color: #0000ff;">void</span><span style="color: #000000;">);

    </span><span style="color: #0000ff;">private</span><span style="color: #000000;">:
        lua_State</span>*<span style="color: #000000;">  m_pScriptContext;
        </span><span style="color: #0000ff;">void</span>(*m_pErrorHandler)(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">pError);
    };</span>







此时, 我们新的 Lua 程序库就制作完毕了, 使用时只要将 **刚修改的 CLua.h、LuaLib_Debug.lib** 和 **LuaLib_Release.lib** 三份文件复制到工程目录下, 然后在合适的地方导入头文件 #include "CLua.h" 就可以了.



* * *



接下来使用 CLua 来实现第二篇中的例子.
打开 VS2013 新创建一个 win32 应用程序 工程, 将 CLua.h、LuaLib_Debug.lib 和 LuaLib_Release.lib 三份文件拷贝过去.
修改源码如下:





    #include <windows.h><span style="color: #000000;">
    #include </span><span style="color: #800000;">"</span><span style="color: #800000;">CLua.h</span><span style="color: #800000;">"</span><span style="color: #000000;">


    LuaGlue LuaGule_Out(lua_State</span>*<span style="color: #000000;"> L) {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">This is a LuaGule! \r\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
        </span><span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
    }

    </span><span style="color: #0000ff;">int</span> _tmain(<span style="color: #0000ff;">int</span> argc, _TCHAR*<span style="color: #000000;"> argv[]) {
        cLua lua;
        lua.AddFunction(</span><span style="color: #800000;">"</span><span style="color: #800000;">新函数</span><span style="color: #800000;">"</span><span style="color: #000000;">, LuaGule_Out);
        lua.RunScript(</span><span style="color: #800000;">"</span><span style="color: #800000;">C:/Users/Administrator/Desktop/test.lua</span><span style="color: #800000;">"</span><span style="color: #000000;">);

        system(</span><span style="color: #800000;">"</span><span style="color: #800000;">PAUSE</span><span style="color: #800000;">"</span><span style="color: #000000;">);
        </span><span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
    }</span>







可以看到, 相对第二篇中的程序, 新代码中的主要变化有:
*. 主程序中不再有初始化和关闭 Lua 环境的代码;
*. LuaGlue 函数的定义因为使用了 LuaGlue 宏而简化了;
*. 注册 LuaGlue 函数的 Lua API 被 CLua::AddFunction 代替;
*. 执行 Lua 脚本的 Lua API 被 CLua::RunScript 代替.
 ??
