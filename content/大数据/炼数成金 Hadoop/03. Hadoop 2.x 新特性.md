Title: 03. Hadoop 2.x 新特性
Author: Martin
Date: 2016-10-23 19:21
Summary: Hadoop 2.x 新特性

[TOC]

# Hadoop 1.x 问题
主要就是 NameNode 单点问题.

Hadoop 1.x 中, 一个集群就只有一个 NameNode, 这种架构虽然实现简单, 但会产生**单点**、**内存**瓶颈、**性能**
瓶颈等限制.

**首先**, 整个 Hadoop 集群的命名空间都归一个 NameNode 管理, 这样 HDFS 所能存储的文件数量会受到 NameNode 容量的限制;

**其次**, 当集群进行复杂运算时, 也只有一个 NameNode 在运作, 集群的运算性能也会受到 NameNode 的限制.

**最后**, 虽然集群有 Second NameNode 作为辅助节点, 但并不会完成自动切换, 当 NameNode 宕掉时, 还是需要人工去处理.

虽然仅仅在像 Yahoo 和 Facebook 返种规模的大公司才会面对这样的限制问题, 但在 Hadoop 2.x 中, 官方还是给出了解决方案.

# Hadoop 2.x 解决方案
Hadoop 2.x 提出了两个新特性用以解决以上问题:

- HDFS 联邦
- HDFS HA (要用到 zookeeper 等，留在后面再讲)

## 联邦
HDFS 联邦提供了 Hadoop 集群多 NameNode 的能力, 让集群可以水平扩展, 一定程度解决了单 NameNode 的**内存**瓶颈和**性能**
瓶颈.

HDFS 联邦中, 每个 **NameNode** 都是独立的, 不需要和其它 **NameNode** 协调合作, 但是 DataNode 作为统一的块存储设备被所有 NameNode 共享.

每一个 **DataNode** 都在所有的 **NameNode** 进行注册, DataNode 发送心跳信息、块报告到所有的 NameNode 上, 同时呢, 也执行所有 NameNode 发来的命令, 而 NameNode 通过 **Block Pools** (块池) 对其进行管理.

![](http://blog.smallcpp.com/theme/images/Hadoop新特性/HDFS联邦.png)

## 块池
**块池**是逻辑上的概念, 就是属于单个命名空间的一组块, 同一个 DataNode 中可以存在着属于多个 Block Pool 的多个块, Block Pool 允许一个 NameNode 在不通知其他 NameNode 的情况下为一个新的 Block 创建 Block ID, 一个 NameNode 失效不会影响其下的 DataNode 为其他 NameNode 的服务.

当向集群存储数据时, 集群先为其分配 NameNode 创建命名空间, 然后 Block Pools 从 DataNode 上寻找空闲 Block 加入当前 NameNode 所管辖下的块池, 最后 NameNode 将数据存放进这些 Block.

## 启用联邦
### 设置配置文件
要使用 HDFS 联邦, 只需在 `hdfs-site.xml` 中修改如下选项即可:

```xml
<property>
    <name>dfs.nameservices</name>
    <value>namenode1,namenode2</value>
</property>
```
<br>
### 格式化 NameNode
第一个 NameNode 可以使用之前的 `hdfs namenode -format` 命令进行格式化, 格式化后就会产生一个 **ClusterId**, 剩下的 NameNode 需要指定 **ClusterId** 进行格式化: `hdfs namenode -format -clusterId`.

# HDFS 快照
在 2.x 终于实现了快照.

- 设置一个目录为可快照:
    + `hdfs dfsadmin -allowSnapshot <path>`
- 取消目录可快照:
    + `hdfs dfsadmin -disallowSnapshot <path>`
- 生成快照:
    + `hdfs dfs -createSnapshot <path> [<snapshotName>]`
- 删除快照:
    + `hdfs dfs -deleteSnapshot <path> <snapshotName>`
- 列出所有可快照目录:
    + `hdfs lsSnapshottableDir`
- 比较快照之间的差异:
    + `hdfs snapshotDiff <path> <fromSnapshot> <toSnapshot>`

![](http://blog.smallcpp.com/theme/images/Hadoop新特性/快照.png)
