<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=device-width" />

    <title>053、NIO</title>

    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/normalize.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/foundation.min.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/style.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/pygments.css" />
    <link rel="shortcut icon" type="image/x-icon" href="http://blog.smallcpp.com/theme/images/favicon.ico" />
    <script src="http://blog.smallcpp.com/theme/js/modernizr.js"></script>
</head>

<body>

<!-- Nav Bar -->
<nav>
<div class="top-bar">
<div class="row">
    <div class="large-9 large-centered columns">
	    <h1><a href="http://blog.smallcpp.com">Small Cpp | 勿在浮沙筑高台, 练从难处练, 用从易处用.</a></h1>
    </div>
</div>
</div>

<!-- Show menu items and pages -->
<div class="row">
<div class="large-9 columns">
    <ul class="button-group navigation">

    </ul>
</div>
</div>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->
<div class="row">

    <!-- Main Blog Content -->
    <div class="large-9 columns">
<article>
    <header>
        <h3 class="article-title"><a href="http://blog.smallcpp.com/053-nio.html" rel="bookmark"
        title="Permalink to 053、NIO">053、NIO</a></h3>
    </header>

<h6 class="subheader" title="2016-08-09T15:22:00+08:00">Tue 09 August 2016
</h6>


    <div class="toc">
<ul>
<li><a href="#_1">概述</a></li>
<li><a href="#buffer">Buffer</a><ul>
<li><a href="#heap-buffer-direct-buffer">Heap Buffer 与 Direct Buffer.</a></li>
<li><a href="#bytebuffer">ByteBuffer</a></li>
</ul>
</li>
<li><a href="#channel">Channel</a><ul>
<li><a href="#memory-mapped">Memory Mapped</a></li>
<li><a href="#_2">说明:</a></li>
</ul>
</li>
</ul>
</div>
<p>Reference: <a href="http://ifeve.com/java-nio-all/">Java NIO 系列教程</a></p>
<h1 id="_1"><a name="user-content-_1" href="#_1" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>概述</h1>
<p>原有的 I/O 流有着太多的软件层次需要提速:</p>
<ul>
<li>小数据块的大量复制</li>
<li>在不切换线程上下文的情况下没有办法在多个源之间进行数据的复用</li>
<li>无法利用现代 OS 的高性能 I/O 特性 (比如内存和 file 映射)</li>
</ul>
<p>NIO 主要变化:</p>
<ul>
<li>Buffer 类允许在 JVM 和 OS 之间使用很小的内存到内存复制技术来移动数据, 而且不需要过度开销</li>
<li>统一的 Channel 类族允许在 Buffer 和文件或 Socket 之间直接交换数据而不需要像原有的 Stream 类那样借助于中间媒介</li>
<li>NIO 首次提供了文件锁定机制</li>
</ul>
<p>和 NIO 相关的类都在 <code>java.nio</code> 包下</p>
<h1 id="buffer"><a name="user-content-buffer" href="#buffer" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Buffer</h1>
<h2 id="heap-buffer-direct-buffer"><a name="user-content-heap-buffer-direct-buffer" href="#heap-buffer-direct-buffer" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Heap Buffer 与 Direct Buffer.</h2>
<p>Buffer 有两种一种是 <strong>Heap Buffer</strong>, 另一种是 <strong>Direct Buffer</strong>.</p>
<p>第一种方式是分配 JVM 堆内存, 属于 GC 管辖范围, 由于需要拷贝所以速度相对较慢 (由于 Java 程序运行在 JVM 中, 所以旧的 I/O 流都是需要在 OS 本地内存中转一下);<br>
第二种方式是分配 OS 本地内存, 不属于 GC 管辖范围, 由于不需要内存拷贝所以速度相对较快.</p>
<blockquote>
<p>由于构造和析构 Direct Buffer 时间成本高, 建议使用**缓冲池**, 参见 netty 的实现.</p>
</blockquote>
<p><strong>References</strong>:<br>
<a href="http://eyesmore.iteye.com/blog/1133335">JAVA NIO 之 Direct Buffer 与 Heap Buffer 的区别？</a><br>
<a href="http://stevex.blog.51cto.com/4300375/1582209">JAVA NIO 内存泄露</a></p>
<h2 id="bytebuffer"><a name="user-content-bytebuffer" href="#bytebuffer" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>ByteBuffer</h2>
<p><strong>创建</strong> ByteBuffer 有两种方法:</p>
<ul>
<li>使用 <code>allocate()</code> 或者 <code>allocateDirect()</code> 静态方法</li>
<li>通过 <code>wrap()</code> 静态方法包装一个已有的数组来创建</li>
</ul>
<p>通过 put 系列方法可将数据**写入** ByteBuffer, 如:</p>
<ul>
<li>putChar(char value)</li>
<li>putChar(int index, char value)</li>
<li>putInt(int value)</li>
<li>putInt(int index, int value)</li>
</ul>
<p>然后通过 get 系列方法可**获取** ByteBuffer 中的数据 (注意, 写入/读取数据顺序要一致, 才能读到想要的数据).</p>
<p>ByteBuffer还可以**设置** byte 的顺序.</p>
<ul>
<li><code>java.io</code> 中数据对流的渲染总是**大位在前**.</li>
<li><code>java.nio</code> 中则可以用指定字节顺序.<ul>
<li><code>order(ByteOrder.BIG_ENDIAN)</code> 大位在前</li>
<li><code>order(ByteOrder.LITTLE_ENDIAN)</code> 小位在前</li>
<li><code>order(ByteOrder.nativeOrder())</code> 本地顺序</li>
</ul>
</li>
</ul>
<p>ByteBuffer 无法用于**数组传输**, 一般的做法是将 ByteBuffer 转换成对应类型的 Buffer, 然后向其中写入数据, 例如在当前位置向 ByteBuffer 中写入 float[]:</p>
<p><div class="codehilite" style="background: #F7F7F7"><pre style="line-height: 125%"><span></span><span style="color: #A71D5D; font-weight: bold">float</span><span style="color: #A71D7E">[]</span> <span style="color: #333333">array</span><span style="color: #A71D7E">;</span>
<span style="color: #999988; font-style: italic">// ... 其它代码</span>

<span style="color: #333333">FloarBuffer</span> <span style="color: #333333">floatBuf</span> <span style="color: #A71D7E">=</span> <span style="color: #333333">byteBuffer</span><span style="color: #A71D7E">.</span><span style="color: #008080">asFloatBuffer</span><span style="color: #A71D7E">();</span>
<span style="color: #333333">floatBuf</span><span style="color: #A71D7E">.</span><span style="color: #008080">put</span><span style="color: #A71D7E">(</span><span style="color: #333333">array</span><span style="color: #A71D7E">);</span>
</pre></div>

<br></p>
<h1 id="channel"><a name="user-content-channel" href="#channel" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Channel</h1>
<p>回想一下之前学的 I/O, 先建立一个流, 然后从流中读取/写入数据, 而在 NIO 中, 我们不用流而用 <strong>Channel</strong>, 它类似流, 但又有些不同:</p>
<ul>
<li>既可以从通道中读取数据, 又可以写数据到通道, 但流的读写通常是单向的</li>
<li>通道中的数据总是要先读到一个 Buffer, 或者总是要从一个 Buffer 中写入</li>
<li>通道可以异步地读写</li>
</ul>
<p><code>java.nio.channels.Channel</code></p>
<p>它的 JavaDoc 如下:</p>
<p>A nexus for I/O operations.</p>
<p>A channel represents an open connection to an entity such as a hardware device, a file, a network socket, or a program component that is capable of performing one or more distinct I/O operations, for example reading or writing.</p>
<p>A channel is either open or closed. A channel is open upon creation, and once closed it remains closed. Once a channel is closed, any attempt to invoke an I/O operation upon it will cause a ClosedChannelException to be thrown. Whether or not a channel is open may be tested by invoking its isOpen method.</p>
<p>Channels are, in general, intended to be safe for multithreaded access as described in the specifications of the interfaces and classes that extend and implement this interface.</p>
<p>Channel 是接口, 它有一些重要的实现:</p>
<ul>
<li><code>FileChannel</code> 从文件中读写数据, 可从以下类包装而来<ul>
<li>RandomAccessFile</li>
<li>FileInputStream</li>
<li>FileOutputStream</li>
</ul>
</li>
<li><code>DatagramChannel</code> 能通过 UDP 读写网络中的数据<ul>
<li>可从 DatagramSocket 包装而来</li>
</ul>
</li>
<li><code>SocketChannel</code> 能通过 TCP 读写网络中的数据<ul>
<li>可从 Socket 包装而来</li>
</ul>
</li>
<li><code>ServerSocketChannel</code> 可以监听新进来的 TCP 连接, 像 Web 服务器那样, 对每一个新进来的连接都会创建一个 SocketChannel<ul>
<li>可从 ServerSocket 包装而来</li>
</ul>
</li>
</ul>
<p>下面是一个使用 FileChannel 读取数据到 Buffer 中的示例:</p>
<p><div class="codehilite" style="background: #F7F7F7"><pre style="line-height: 125%"><span></span><span style="color: #333333">RandomAccessFile</span> <span style="color: #333333">aFile</span> <span style="color: #A71D7E">=</span> <span style="color: #A71D5D">new</span> <span style="color: #333333">RandomAccessFile</span><span style="color: #A71D7E">(</span><span style="color: #183691">&quot;data/nio-data.txt&quot;</span><span style="color: #A71D7E">,</span> <span style="color: #183691">&quot;rw&quot;</span><span style="color: #A71D7E">);</span>
<span style="color: #333333">FileChannel</span> <span style="color: #333333">inChannel</span> <span style="color: #A71D7E">=</span> <span style="color: #333333">aFile</span><span style="color: #A71D7E">.</span><span style="color: #008080">getChannel</span><span style="color: #A71D7E">();</span>

<span style="color: #333333">ByteBuffer</span> <span style="color: #333333">buf</span> <span style="color: #A71D7E">=</span> <span style="color: #333333">ByteBuffer</span><span style="color: #A71D7E">.</span><span style="color: #008080">allocate</span><span style="color: #A71D7E">(</span><span style="color: #0086b3">48</span><span style="color: #A71D7E">);</span>

<span style="color: #A71D5D; font-weight: bold">int</span> <span style="color: #333333">bytesRead</span> <span style="color: #A71D7E">=</span> <span style="color: #333333">inChannel</span><span style="color: #A71D7E">.</span><span style="color: #008080">read</span><span style="color: #A71D7E">(</span><span style="color: #333333">buf</span><span style="color: #A71D7E">);</span>
<span style="color: #A71D5D">while</span> <span style="color: #A71D7E">(</span><span style="color: #333333">bytesRead</span> <span style="color: #A71D7E">!=</span> <span style="color: #A71D7E">-</span><span style="color: #0086b3">1</span><span style="color: #A71D7E">)</span> <span style="color: #A71D7E">{</span>
    <span style="color: #333333">System</span><span style="color: #A71D7E">.</span><span style="color: #008080">out</span><span style="color: #A71D7E">.</span><span style="color: #008080">println</span><span style="color: #A71D7E">(</span><span style="color: #183691">&quot;Read &quot;</span> <span style="color: #A71D7E">+</span> <span style="color: #333333">bytesRead</span><span style="color: #A71D7E">);</span>
    <span style="color: #333333">buf</span><span style="color: #A71D7E">.</span><span style="color: #008080">flip</span><span style="color: #A71D7E">();</span>

    <span style="color: #A71D5D">while</span><span style="color: #A71D7E">(</span><span style="color: #333333">buf</span><span style="color: #A71D7E">.</span><span style="color: #008080">hasRemaining</span><span style="color: #A71D7E">()){</span>
        <span style="color: #333333">System</span><span style="color: #A71D7E">.</span><span style="color: #008080">out</span><span style="color: #A71D7E">.</span><span style="color: #008080">print</span><span style="color: #A71D7E">((</span><span style="color: #A71D5D; font-weight: bold">char</span><span style="color: #A71D7E">)</span><span style="color: #333333">buf</span><span style="color: #A71D7E">.</span><span style="color: #008080">get</span><span style="color: #A71D7E">());</span>
    <span style="color: #A71D7E">}</span>

    <span style="color: #333333">buf</span><span style="color: #A71D7E">.</span><span style="color: #008080">clear</span><span style="color: #A71D7E">();</span>
    <span style="color: #333333">bytesRead</span> <span style="color: #A71D7E">=</span> <span style="color: #333333">inChannel</span><span style="color: #A71D7E">.</span><span style="color: #008080">read</span><span style="color: #A71D7E">(</span><span style="color: #333333">buf</span><span style="color: #A71D7E">);</span>
<span style="color: #A71D7E">}</span>
<span style="color: #333333">aFile</span><span style="color: #A71D7E">.</span><span style="color: #008080">close</span><span style="color: #A71D7E">();</span>
</pre></div>

<br>
注意 <code>buf.flip()</code> 的调用, 它的作用有两个:</p>
<ul>
<li>把 limit 设置为当前的 position 值</li>
<li>把 position 设置为 0</li>
</ul>
<p>然后处理的数据就是从 position 到 limit 直接的数据, 也就是刚刚读取过来的数据.</p>
<h2 id="memory-mapped"><a name="user-content-memory-mapped" href="#memory-mapped" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Memory Mapped</h2>
<p>虚拟内存映射: 把文件的某一段(磁盘/硬盘上)直接映射到内存中去; 一旦文件被映射, 访问文件就会非常快, 不用通过系统的 <code>read()</code> 或 <code>write()</code>.</p>
<p><div class="codehilite" style="background: #F7F7F7"><pre style="line-height: 125%"><span></span><span style="color: #333333">MappedByteBuffer</span> <span style="color: #333333">FileChannel</span><span style="color: #A71D7E">.</span><span style="color: #008080">map</span><span style="color: #A71D7E">(</span><span style="color: #333333">MapMode</span><span style="color: #A71D7E">,</span> <span style="color: #A71D5D; font-weight: bold">long</span> <span style="color: #333333">position</span><span style="color: #A71D7E">,</span> <span style="color: #333333">longsize</span><span style="color: #A71D7E">)</span>
<span style="color: #999988; font-style: italic">// MapMode 映射 mode: READ_ONLY、READ_WRITE、PRIVATE</span>
</pre></div>

<br>
通过 <code>FileChannel</code> 可以将文件映射到内存中, 取得一个 <code>MappedByteBuffer</code>.</p>
<h2 id="_2"><a name="user-content-_2" href="#_2" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>说明:</h2>
<p>剩下的还有 162 ~ 166 没看, 看不下去了,  以后再看吧</p>
<p class="subheader">Category: <a href="http://blog.smallcpp.com/category/da-shu-ju.html">大数据</a>

</p>




<!--      -->

    <!-- 多说评论框 start -->
    <h4>Comments !</h4>
    <div class="ds-thread" data-thread-key="053-nio" data-title="053、NIO" data-url="http://blog.smallcpp.com/053-nio.html"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
        var duoshuoQuery = {short_name:"smallcpp"};
            (function() {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';ds.async = true;
                ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
    </script>
    <!-- 多说公共JS代码 end -->
</article>
    </div>
    <!-- End Main Content -->

    <!-- Sidebar -->
    <aside class="large-3 columns">
        <h5 class="sidebar-title">Site</h5>
        <ul class="side-nav">
            <li><a href="http://blog.smallcpp.com/archives.html">Archives</a>
            <li><a href="http://blog.smallcpp.com/tags.html">Tags</a>
        </ul>

        <h5 class="sidebar-title">Categories</h5>
        <ul class="side-nav">
            <li><a href="http://blog.smallcpp.com/category/ban-ben-kong-zhi.html">版本控制</a></li>
            <li><a href="http://blog.smallcpp.com/category/c11-xin-te-xing.html">C++11 新特性</a></li>
            <li><a href="http://blog.smallcpp.com/category/cocos2d-you-xi-kai-fa.html">Cocos2d 游戏开发</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-hua-she-ji-mo-shi.html">大话设计模式</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-shu-ju.html">大数据</a></li>
            <li><a href="http://blog.smallcpp.com/category/du-shu-bi-ji.html">读书笔记</a></li>
            <li><a href="http://blog.smallcpp.com/category/golang.html">Golang</a></li>
            <li><a href="http://blog.smallcpp.com/category/hadoop.html">hadoop</a></li>
            <li><a href="http://blog.smallcpp.com/category/hei-ke-ji.html">黑科技</a></li>
            <li><a href="http://blog.smallcpp.com/category/lian-shu-cheng-jin-hadoop.html">炼数成金 Hadoop</a></li>
            <li><a href="http://blog.smallcpp.com/category/ling-ji-chu-qt-ru-men.html">零基础 QT 入门</a></li>
            <li><a href="http://blog.smallcpp.com/category/linux.html">Linux</a></li>
            <li><a href="http://blog.smallcpp.com/category/lua-you-xi-kai-fa.html">Lua 游戏开发</a></li>
            <li><a href="http://blog.smallcpp.com/category/pyqt-kai-fa.html">PyQt 开发</a></li>
            <li><a href="http://blog.smallcpp.com/category/python-cong-ru-men-dao-fang-qi.html">Python 从入门到放弃</a></li>
            <li><a href="http://blog.smallcpp.com/category/shen-ru-qian-chu-mongodb.html">深入浅出 Mongodb</a></li>
            <li><a href="http://blog.smallcpp.com/category/shen-ru-qian-chu-redis.html">深入浅出 Redis</a></li>
            <li><a href="http://blog.smallcpp.com/category/za-xiang.html">杂项</a></li>
            <li><a href="http://blog.smallcpp.com/category/zai-xue-java.html">再学 JAVA</a></li>
        </ul>

        <h5 class="sidebar-title">Links</h5>
        <ul class="side-nav">
            <li><a href="http://blog.csdn.net/u010850265">CSDN</a></li>
        </ul>

        <h5 class="sidebar-title">Social</h5>
        <ul class="side-nav">
            <li><a href="http://blog.csdn.net/u010850265">CSDN</a></li>
        </ul>

    </aside> <!-- End Sidebar -->

</div> <!-- End Main Content and Sidebar -->


<!-- Footer -->
<footer class="row">
    <div class="large-12 columns">
        <hr />
        <div class="row">
            <div class="large-6 columns">
              <!--                  <p>Small Cpp | 勿在浮沙筑高台, 练从难处练, 用从易处用. by martin</p> -->
            </div>
            </div>
    </div>
</footer>
</body>
</html>