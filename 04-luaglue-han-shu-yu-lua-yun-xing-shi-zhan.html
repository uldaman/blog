<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=device-width" />

    <title>04. LuaGlue 函数 与 Lua 运行时栈</title>

    <link rel="stylesheet" href="http://blog.smallcpp.cn/theme/css/normalize.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.cn/theme/css/foundation.min.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.cn/theme/css/style.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.cn/theme/css/pygments.css" />
    <link rel="shortcut icon" type="image/x-icon" href="http://blog.smallcpp.cn/theme/images/favicon.ico" />
    <script src="http://blog.smallcpp.cn/theme/js/modernizr.js"></script>
</head>

<body>

<!-- Nav Bar -->
<nav>
<div class="top-bar">
<div class="row">
    <div class="large-9 large-centered columns">
	    <h1><a href="http://blog.smallcpp.cn">Small Cpp | 勿在浮沙筑高台, 练从难处练, 用从易处用.</a></h1>
    </div>
</div>
</div>

<!-- Show menu items and pages -->
<div class="row">
<div class="large-9 columns">
    <ul class="button-group navigation">

    </ul>
</div>
</div>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->
<div class="row">

    <!-- Main Blog Content -->
    <div class="large-9 columns">
<article>
    <header>
        <h3 class="article-title"><a href="http://blog.smallcpp.cn/04-luaglue-han-shu-yu-lua-yun-xing-shi-zhan.html" rel="bookmark"
        title="Permalink to 04. LuaGlue 函数 与 Lua 运行时栈">04. LuaGlue 函数 与 Lua 运行时栈</a></h3>
    </header>

<h6 class="subheader" title="2015-03-15T16:17:00+08:00">Sun 15 March 2015
</h6>


    <p>在之前, 我们写了一个很简单的 LuaGlue 函数, 然而这个函数不接收参数和也没有返回值, 但是不可否认的是, LuaGlue 函数具有传递参数和返回值的能力.<br>
这种功能通过 Lua 运行时栈来完实现.</p>
<p>要搞明白 Lua 栈, 首先要搞清楚栈的索引是如何定义的.</p>
<p><img alt="" src="http://i57.tinypic.com/219xv1h.jpg"></p>
<p>当初始化一个栈的时候, 它的栈底索引是 1, 而栈顶相对索引是 -1.<br>
Lua 栈的结构和 C/C++ 的栈具有异曲同工之处, 即先进后出, 最选压栈的元素被保存在栈底.</p>
<p>假设存在一个 LuaGlue 函数 Add(int i, intj), 它接收两个整型参数并返回相加的结果;<br>
现在, 我们在 Lua 脚本中使用它: local nRet = Add(11, 12);<br>
我们来看看 Lua 栈的变化过程.<br>
当执行到这段代码的时候, 首先把函数名(Add)压栈, 然后将第一个参数(11)压栈, 再将第二个参数(12)压栈, 此时栈变成这样:</p>
<p><img alt="" src="http://i60.tinypic.com/2ch9b4h.jpg">.</p>
<p>然后 Lua 解释器取出栈底的函数名, 通过函数名找到函数的入口, 进入函数主体, 此时栈是这样的:</p>
<p><img alt="" src="http://i57.tinypic.com/2el9yy8.jpg"></p>
<p>此时已经进入 C/C++ 写的 LuaGlue 函数底层代码.<br>
C/C++ 从 Lua 栈中取出里面的两个参数进行加法计算, 然后将结果压栈, 现在栈变成了这样:</p>
<p><img alt="" src="http://i61.tinypic.com/5zdtzk.jpg"></p>
<p>函数调用成功返回之后, Lua 解释器释放掉参数栈保留返回值栈, 此时栈是这样的:</p>
<p><img alt="" src="http://i61.tinypic.com/2ev6h3k.jpg"></p>
<p>最后, Lua 解释器将这个返回值取出并赋值给 nRet, 此时 Lua 栈为空.</p>
<p>那么问题来了!<br>
在 C/C++ 写的 LuaGlue 函数底层代码中, 怎么取出这些参数, 然后又怎么将计算结果压回栈, 最后又是怎么设置栈底指针的呢?<br>
cLua 类中的 GetIntArgument 方法能够从 Lua 栈中返回一个整型数据.</p>
<div class="codehilite" style="background: #eeeedd"><pre style="line-height: 125%"><span></span><span style="color: #00688B; font-weight: bold">int</span> cLua::GetIntArgument(<span style="color: #00688B; font-weight: bold">int</span> num, <span style="color: #00688B; font-weight: bold">int</span> nDefault <span style="color: #228B22">/*= 0*/</span>) {
    <span style="color: #8B008B; font-weight: bold">return</span> luaL_optinteger(m_pScriptContext, num, nDefault);
}
</pre></div>


<p><br>
而 cLua 类中的 PushInt 方法能够向 Lua 栈中压入一个整型数据.</p>
<div class="codehilite" style="background: #eeeedd"><pre style="line-height: 125%"><span></span><span style="color: #00688B; font-weight: bold">void</span> cLua::PushInt(<span style="color: #00688B; font-weight: bold">int</span> value) {
    lua_pushinteger(m_pScriptContext, value);
}
</pre></div>


<p><br>
这两个方法都要求传入参数在 Lua 栈中的位置.</p>
<p>好了, 现在我们大概可以写出这个 LuaGlue 的底层代码了:</p>
<div class="codehilite" style="background: #eeeedd"><pre style="line-height: 125%"><span></span>LuaGlue <span style="color: #008b45">LuaGlue_Add</span>(lua_State* L) {
    <span style="color: #00688B; font-weight: bold">int</span> argNum = <span style="color: #B452CD">1</span>;
    <span style="color: #00688B; font-weight: bold">int</span> nSum1 = luaL_optinteger(L, argNum++, <span style="color: #B452CD">0</span>);   <span style="color: #228B22">// 取出参数一</span>
    <span style="color: #00688B; font-weight: bold">int</span> nSum2 = luaL_optinteger(L, argNum++, <span style="color: #B452CD">0</span>);   <span style="color: #228B22">// 取出参数二</span>
    lua_pushinteger(L, nSum1 + nSum2);      <span style="color: #228B22">// 压入结果</span>
    <span style="color: #8B008B; font-weight: bold">return</span> <span style="color: #B452CD">1</span>;   <span style="color: #228B22">// 表示此 LuaGlue 函数有一个返回值</span>
}
</pre></div>


<p><br>
最后, 需要说明的是 LuaGlue 函数的返回值个数, Lua 函数可以返回多个值, LuaGlue 函数也支持这个特性.<br>
它通过最后一句代码 return x; 来指定到底返回了几个值, 当然这个数值必须要和 Lua 栈中实际 Push 进的返回值数量一致.<br>
另外, 这个函数中还用到一个小技巧, 在函数开始定义了一个局部变量并初始为 1, 每当从 Lua 栈中读取了一个参数就递加 1.</p>
<p class="subheader">Category: <a href="http://blog.smallcpp.cn/category/lua.html">Lua</a>

</p>




<!--      -->

    <!-- 多说评论框 start -->
    <h4>Comments !</h4>
    <div class="ds-thread" data-thread-key="04-luaglue-han-shu-yu-lua-yun-xing-shi-zhan" data-title="04. LuaGlue 函数 与 Lua 运行时栈" data-url="http://blog.smallcpp.cn/04-luaglue-han-shu-yu-lua-yun-xing-shi-zhan.html"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
        var duoshuoQuery = {short_name:"smallcpp"};
            (function() {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';ds.async = true;
                ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
    </script>
    <!-- 多说公共JS代码 end -->
</article>
    </div>
    <!-- End Main Content -->

    <!-- Sidebar -->
    <aside class="large-3 columns">
        <h5 class="sidebar-title">Site</h5>
        <ul class="side-nav">
            <li><a href="http://blog.smallcpp.cn/archives.html">Archives</a>
            <li><a href="http://blog.smallcpp.cn/tags.html">Tags</a>
        </ul>

        <h5 class="sidebar-title">Categories</h5>
        <ul class="side-nav">
            <li><a href="http://blog.smallcpp.cn/category/c11.html">C++11</a></li>
            <li><a href="http://blog.smallcpp.cn/category/da-hua-she-ji-mo-shi.html">大话设计模式</a></li>
            <li><a href="http://blog.smallcpp.cn/category/da-shu-ju.html">大数据</a></li>
            <li><a href="http://blog.smallcpp.cn/category/du-shu-bi-ji.html">读书笔记</a></li>
            <li><a href="http://blog.smallcpp.cn/category/golang.html">Golang</a></li>
            <li><a href="http://blog.smallcpp.cn/category/hei-ke-ji.html">黑科技</a></li>
            <li><a href="http://blog.smallcpp.cn/category/java-ru-men-dao-jing-tong.html">Java 入门到精通</a></li>
            <li><a href="http://blog.smallcpp.cn/category/linux-ru-men-dao-jing-tong.html">Linux 入门到精通</a></li>
            <li><a href="http://blog.smallcpp.cn/category/lua.html">Lua</a></li>
            <li><a href="http://blog.smallcpp.cn/category/mongodb-ru-men-dao-jing-tong.html">Mongodb 入门到精通</a></li>
            <li><a href="http://blog.smallcpp.cn/category/pyqt.html">PyQt</a></li>
            <li><a href="http://blog.smallcpp.cn/category/python.html">Python</a></li>
            <li><a href="http://blog.smallcpp.cn/category/qt.html">QT</a></li>
            <li><a href="http://blog.smallcpp.cn/category/qu-kuai-lian.html">区块链</a></li>
            <li><a href="http://blog.smallcpp.cn/category/redis-ru-men-dao-jing-tong.html">Redis 入门到精通</a></li>
            <li><a href="http://blog.smallcpp.cn/category/ruan-jian-she-ji.html">软件设计</a></li>
            <li><a href="http://blog.smallcpp.cn/category/za-xiang.html">杂项</a></li>
        </ul>

        <h5 class="sidebar-title">Links</h5>
        <ul class="side-nav">
            <li><a href="http://blog.csdn.net/u010850265">CSDN</a></li>
        </ul>

        <h5 class="sidebar-title">Social</h5>
        <ul class="side-nav">
            <li><a href="http://blog.csdn.net/u010850265">CSDN</a></li>
        </ul>

    </aside> <!-- End Sidebar -->

</div> <!-- End Main Content and Sidebar -->


<!-- Footer -->
<footer class="row">
    <div class="large-12 columns">
        <hr />
        <div class="row">
            <div class="large-6 columns">
              <!--                  <p>Small Cpp | 勿在浮沙筑高台, 练从难处练, 用从易处用. by martin</p> -->
            </div>
            </div>
    </div>
</footer>
</body>
</html>