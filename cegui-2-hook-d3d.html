<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=device-width" />

    <title>'[CEGUI]. 2、HOOK D3D'</title>

    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/normalize.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/foundation.min.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/style.css" />
    <link rel="stylesheet" href="http://blog.smallcpp.com/theme/css/pygments.css" />
    <link rel="shortcut icon" type="image/x-icon" href="http://blog.smallcpp.com/theme/images/favicon.ico" />
    <script src="http://blog.smallcpp.com/theme/js/modernizr.js"></script>
</head>

<body>

<!-- Nav Bar -->
<nav>
<div class="top-bar">
<div class="row">
    <div class="large-9 large-centered columns">
	    <h1><a href="http://blog.smallcpp.com">Small Cpp | 勿在浮沙筑高台, 练从难处练, 用从易处用.</a></h1>
    </div>
</div>
</div>

<!-- Show menu items and pages -->
<div class="row">
<div class="large-9 columns">
    <ul class="button-group navigation">

    </ul>
</div>
</div>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->
<div class="row">

    <!-- Main Blog Content -->
    <div class="large-9 columns">
<article>
    <header>
        <h3 class="article-title"><a href="http://blog.smallcpp.com/cegui-2-hook-d3d.html" rel="bookmark"
        title="Permalink to '[CEGUI]. 2、HOOK D3D'">'[CEGUI]. 2、HOOK D3D'</a></h3>
    </header>

<h6 class="subheader" title="2015-05-27T16:06:00+08:00">Wed 27 May 2015
</h6>


    <p>使用 CEGUI 的第一步是要创建一个 Renderer 对象(渲染对象) 参考: <a href="http://blog.csdn.net/bluekane/article/details/3738376">cegui渲染入门</a></p>
<p>最新的 CEGUI 支持的渲染组件有: Direct3D9、Direct3D10、Direct3D11、OpenGl、Ogre3d 等.</p>
<p>一般的游戏都使用的是 Direct3D 系列, 而要创建一个 D3D Renderer 对象就需要提供一个参数, 即 Direct3DDevice (D3D 设备句柄), 这个参数由 D3D API CreateDevice() 得到;
但是, 如果要想在游戏中使用 CEGUI 自绘界面, 就必须使用游戏本身创建的 Direct3DDevice, 而不能直接自己调用 CreateDevice();
那么要想获得游戏的 Direct3DDevice, 就需要 HOOK D3D, 在游戏调用 CreateDevice() 时取得游戏创建的 Direct3DDevice.</p>
<p>HOOK D3D 的源码网上流传的有很多, 这里也收集了两份:
注入法: <a href="http://yunpan.cn/cwmYIwqDQYGzX"><a href="http://yunpan.cn/cwmYIwqDQYGzX"><a href="http://yunpan.cn/cwmYIwqDQYGzX">http://yunpan.cn/cwmYIwqDQYGzX</a></a></a>  访问密码 9694
劫持法: <a href="http://yunpan.cn/cw3V3zaqMkBdF"><a href="http://yunpan.cn/cw3V3zaqMkBdF"><a href="http://yunpan.cn/cw3V3zaqMkBdF">http://yunpan.cn/cw3V3zaqMkBdF</a></a></a>  访问密码 c178</p>
<p>这两种方法在最终 HOOK 上采取的方式都一致的, 都是利用了 C++ 继承的特性, 区别只在于 dll 的注入方式.</p>
<p>这里以 d3d9 为例简单说明一下:
首先, 已经知道要 HOOK IDirect3D9::CreateDevice() 这个函数才能取得游戏创建的 Direct3DDevice, 而 CreateDevice() 是 IDirect3D9 接口的虚函数, 这一点我们阅读 D3D 的头文件 d3d9.h 就可以得知(见下面代码摘要), 实际上, d3d 系列的所有函数都是虚函数.</p>
<div class="codehilite" style="background: #F7F7F7"><pre style="line-height: 125%"><span></span><span style="color: #999999; font-weight: bold">#define DECLARE_INTERFACE_(iface, baseiface) interface DECLSPEC_NOVTABLE iface : public baseiface</span>

<span style="color: #999999; font-weight: bold">#define STDMETHOD(method) virtual COM_DECLSPEC_NOTHROW HRESULT STDMETHODCALLTYPE method</span>
<span style="color: #999999; font-weight: bold">#define STDMETHOD_(type,method) virtual COM_DECLSPEC_NOTHROW type STDMETHODCALLTYPE method</span>

<span style="color: #333333">DECLARE_INTERFACE_</span>(<span style="color: #333333">IDirect3D9</span>, <span style="color: #333333">IUnknown</span>) {
    <span style="color: #999988; font-style: italic">/*** IUnknown methods ***/</span>
    <span style="color: #333333">STDMETHOD</span>(<span style="color: #333333">QueryInterface</span>)(<span style="color: #333333">THIS_</span> <span style="color: #333333">REFIID</span> <span style="color: #333333">riid</span>, <span style="color: #A71D5D; font-weight: bold">void</span><span style="color: #A71D7E">**</span> <span style="color: #333333">ppvObj</span>) <span style="color: #333333">PURE</span>;
   ......
    <span style="color: #999988; font-style: italic">/*** IDirect3D9 methods ***/</span>
    <span style="color: #333333">STDMETHOD</span>(<span style="color: #333333">RegisterSoftwareDevice</span>)(<span style="color: #333333">THIS_</span> <span style="color: #A71D5D; font-weight: bold">void</span><span style="color: #A71D7E">*</span> <span style="color: #333333">pInitializeFunction</span>) <span style="color: #333333">PURE</span>;
   ......
};
</pre></div>


<p>游戏初始化时, 会通过 Direct3DCreate9() 创建一个 IDirect3D9 指针, 然后用这个 IDirect3D9 指针调用它的 CreateDevice() 函数;</p>
<p>此时, 如果我们创建一个子类继承 IDirect3D9 类, 然后在游戏初始化前 HOOK Direct3DCreate9() 函数, 在 Direct3DCreate9()  内部用我们刚创建的子类创建一个指针, 并把这个子类的指针返回给游戏;
根据 C++ 继承特性, 这个指针是子类的, 所以当游戏用这个指针调用 d3d 系列的函数时, 如果我们重写了父类的对应虚函数, 那么实际上它调用的就会是我们子类重写后的函数了.</p>
<p>因此, 我们想要 HOOK IDirect3D9::CreateDevice() 取 Direct3DDevice, 只需要在子类中重写 IDirect3D9 的 CreateDevice() 就可以了, 具体代码见上面分享, 个人推荐用劫持的方式, 相对安全一点.</p>
<hr />
<p>除了利用 C++ 继承特性外, 还有一种方法是利用 C++ 虚函数的特性直接 HOOK IDirect3D9 的虚表, 所以有必要先了解一下虚函数的机制: 当类中定义有虚函数时, 编译器会将该类中所有虚函数的地址保存在一张表中, 这张表被称为虚函数地址表(虚表), 同时编译器会在类中添加一个隐藏的数据成员, 即虚表指针, 它指向该类的虚表,  这个隐藏的数据成员在类的开始处, 即类的头 4 字节.</p>
<p>知道了上面这些, 那 HOOK IDirect3D9 的虚表也就不在话下了, 第一步仍然是 HOOK Direct3DCreate9() 取游戏创建的 IDirect3D9 指针, 有了这个指针, 就能从它的头 4 字节处取出虚表, 再找到 CreateDevice() 在虚表中的位置, 替换成我们自己的 CreateDevice(), 然后 OOXX . . .</p>
<p>参考代码:
<div class="codehilite" style="background: #F7F7F7"><pre style="line-height: 125%"><span></span><span style="color: #A71D5D">class</span> <span style="color: #445588">Test</span> {
<span style="color: #A71D5D">public</span><span style="color: #A71D7E">:</span>
    <span style="color: #A71D5D">virtual</span> <span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #333333">Hello</span>() {
        <span style="color: #333333">AfxMessageBox</span>(<span style="color: #A71D5D">nullptr</span>);
    }
};

<span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #A71D5D">__stdcall</span> <span style="color: #795DA3">New_Hello</span>() {
    <span style="color: #333333">AfxMessageBox</span>(<span style="color: #333333">TEXT</span>(<span style="color: #183691">&quot;Hello&quot;</span>));
}

<span style="color: #A71D5D; font-weight: bold">void</span> <span style="color: #795DA3">BnClickedButton</span>() {
    <span style="color: #333333">Test</span><span style="color: #A71D7E">*</span> <span style="color: #333333">pTest</span> <span style="color: #A71D7E">=</span> <span style="color: #A71D5D">new</span> <span style="color: #333333">Test</span>;
    <span style="color: #333333">PVOID</span> <span style="color: #333333">p</span> <span style="color: #A71D7E">=</span> ((<span style="color: #333333">PVOID</span><span style="color: #A71D7E">*</span>)<span style="color: #333333">pTest</span>)[<span style="color: #0086b3">0</span>]; <span style="color: #999988; font-style: italic">// 取虚表</span>
    <span style="color: #333333">DWORD</span> <span style="color: #333333">dwOldPro</span>;
    <span style="color: #333333">VirtualProtect</span>(<span style="color: #333333">p</span>, <span style="color: #0086b3">4</span>, <span style="color: #333333">PAGE_EXECUTE_READWRITE</span>, <span style="color: #A71D7E">&amp;</span><span style="color: #333333">dwOldPro</span>); <span style="color: #999988; font-style: italic">// 修改内存保护属性</span>
    ((<span style="color: #333333">PVOID</span><span style="color: #A71D7E">*</span>)<span style="color: #333333">p</span>)[<span style="color: #0086b3">0</span>] <span style="color: #A71D7E">=</span> <span style="color: #333333">New_Hello</span>; <span style="color: #999988; font-style: italic">// 改函数表函数</span>
    <span style="color: #333333">VirtualProtect</span>(<span style="color: #333333">p</span>, <span style="color: #0086b3">4</span>, <span style="color: #333333">dwOldPro</span>, <span style="color: #A71D7E">&amp;</span><span style="color: #333333">dwOldPro</span>); <span style="color: #999988; font-style: italic">// 恢复内存保护属性</span>
    <span style="color: #333333">pTest</span><span style="color: #A71D7E">-&gt;</span><span style="color: #333333">Hello</span>();
    <span style="color: #A71D5D">delete</span> <span style="color: #333333">pTest</span>;
}
</pre></div>
</p>
<p>最后共享一份 d3d 虚函数的索引: <a href="http://yunpan.cn/cw3kuPtUp2xHu"><a href="http://yunpan.cn/cw3kuPtUp2xHu"><a href="http://yunpan.cn/cw3kuPtUp2xHu">http://yunpan.cn/cw3kuPtUp2xHu</a></a></a>  访问密码 bc7a</p>
<p class="subheader">Category: <a href="http://blog.smallcpp.com/category/hei-ke-ji.html">黑科技</a>

</p>




</article>
    </div>
    <!-- End Main Content -->

    <!-- Sidebar -->
    <aside class="large-3 columns">
        <h5 class="sidebar-title">Site</h5>
        <ul class="side-nav">
            <li><a href="http://blog.smallcpp.com/archives.html">Archives</a>
            <li><a href="http://blog.smallcpp.com/tags.html">Tags</a>
        </ul>

        <h5 class="sidebar-title">Categories</h5>
        <ul class="side-nav">
            <li><a href="http://blog.smallcpp.com/category/ban-ben-kong-zhi.html">版本控制</a></li>
            <li><a href="http://blog.smallcpp.com/category/c11-xin-te-xing.html">C++11 新特性</a></li>
            <li><a href="http://blog.smallcpp.com/category/cocos2d-you-xi-kai-fa.html">Cocos2d 游戏开发</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-hua-she-ji-mo-shi.html">大话设计模式</a></li>
            <li><a href="http://blog.smallcpp.com/category/da-shu-ju.html">大数据</a></li>
            <li><a href="http://blog.smallcpp.com/category/du-shu-bi-ji.html">读书笔记</a></li>
            <li><a href="http://blog.smallcpp.com/category/golang.html">Golang</a></li>
            <li><a href="http://blog.smallcpp.com/category/hadoop.html">hadoop</a></li>
            <li><a href="http://blog.smallcpp.com/category/hei-ke-ji.html">黑科技</a></li>
            <li><a href="http://blog.smallcpp.com/category/ling-ji-chu-qt-ru-men.html">零基础 QT 入门</a></li>
            <li><a href="http://blog.smallcpp.com/category/linux.html">Linux</a></li>
            <li><a href="http://blog.smallcpp.com/category/lua-you-xi-kai-fa.html">Lua 游戏开发</a></li>
            <li><a href="http://blog.smallcpp.com/category/pyqt-kai-fa.html">PyQt 开发</a></li>
            <li><a href="http://blog.smallcpp.com/category/python-cong-ru-men-dao-fang-qi.html">Python 从入门到放弃</a></li>
            <li><a href="http://blog.smallcpp.com/category/shen-ru-qian-chu-mongodb.html">深入浅出 Mongodb</a></li>
            <li><a href="http://blog.smallcpp.com/category/shen-ru-qian-chu-redis.html">深入浅出 Redis</a></li>
            <li><a href="http://blog.smallcpp.com/category/za-xiang.html">杂项</a></li>
            <li><a href="http://blog.smallcpp.com/category/zai-xue-java.html">再学 JAVA</a></li>
        </ul>

        <h5 class="sidebar-title">Links</h5>
        <ul class="side-nav">
            <li><a href="http://blog.csdn.net/u010850265">CSDN</a></li>
        </ul>

        <h5 class="sidebar-title">Social</h5>
        <ul class="side-nav">
            <li><a href="http://blog.csdn.net/u010850265">CSDN</a></li>
        </ul>

    </aside> <!-- End Sidebar -->

</div> <!-- End Main Content and Sidebar -->


<!-- Footer -->
<footer class="row">
    <div class="large-12 columns">
        <hr />
        <div class="row">
            <div class="large-6 columns">
              <!--                  <p>Small Cpp | 勿在浮沙筑高台, 练从难处练, 用从易处用. by martin</p> -->
            </div>
            </div>
    </div>
</footer>
</body>
</html>