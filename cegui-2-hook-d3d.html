<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=device-width" />

    <title>'[CEGUI]. 2、HOOK D3D'</title>

    <link rel="stylesheet" href="http://z351522453.github.com/blog/theme/css/normalize.css" />
    <link rel="stylesheet" href="http://z351522453.github.com/blog/theme/css/foundation.min.css" />
    <link rel="stylesheet" href="http://z351522453.github.com/blog/theme/css/style.css" />
    <link rel="stylesheet" href="http://z351522453.github.com/blog/theme/css/pygments.css" />	
    <script src="http://z351522453.github.com/blog/theme/js/modernizr.js"></script>
</head>

<body>

<!-- Nav Bar -->
<nav>
<div class="top-bar">
<div class="row">
    <div class="large-9 large-centered columns">
	    <h1><a href="http://z351522453.github.com/blog">Small Cpp | 勿在浮沙筑高台, 练从难处练, 用从易处用.</a></h1>
    </div>
</div>
</div>

<!-- Show menu items and pages -->
<div class="row">
<div class="large-9 columns">
    <ul class="button-group navigation">

    </ul>
</div>
</div>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->
<div class="row">

    <!-- Main Blog Content -->
    <div class="large-9 columns">
<article>
    <header>
        <h3 class="article-title"><a href="http://z351522453.github.com/blog/cegui-2-hook-d3d.html" rel="bookmark"
        title="Permalink to '[CEGUI]. 2、HOOK D3D'">'[CEGUI]. 2、HOOK D3D'</a></h3>
    </header>

<h6 class="subheader" title="2015-05-27T16:06:00+08:00">周三 27 五月 2015
</h6>


    <p>使用 CEGUI 的第一步是要创建一个 Renderer 对象(渲染对象) 参考: <a href="http://blog.csdn.net/bluekane/article/details/3738376">cegui渲染入门</a></p>
<p>最新的 CEGUI 支持的渲染组件有: Direct3D9、Direct3D10、Direct3D11、OpenGl、Ogre3d 等.</p>
<p>一般的游戏都使用的是 Direct3D 系列, 而要创建一个 D3D Renderer 对象就需要提供一个参数, 即 Direct3DDevice (D3D 设备句柄), 这个参数由 D3D API CreateDevice() 得到;
但是, 如果要想在游戏中使用 CEGUI 自绘界面, 就必须使用游戏本身创建的 Direct3DDevice, 而不能直接自己调用 CreateDevice();
那么要想获得游戏的 Direct3DDevice, 就需要 HOOK D3D, 在游戏调用 CreateDevice() 时取得游戏创建的 Direct3DDevice.</p>
<p>HOOK D3D 的源码网上流传的有很多, 这里也收集了两份:
注入法: <a href="http://yunpan.cn/cwmYIwqDQYGzX">http://yunpan.cn/cwmYIwqDQYGzX</a>  访问密码 9694
劫持法: <a href="http://yunpan.cn/cw3V3zaqMkBdF">http://yunpan.cn/cw3V3zaqMkBdF</a>  访问密码 c178</p>
<p>这两种方法在最终 HOOK 上采取的方式都一致的, 都是利用了 C++ 继承的特性, 区别只在于 dll 的注入方式.</p>
<p>这里以 d3d9 为例简单说明一下:
首先, 已经知道要 HOOK IDirect3D9::CreateDevice() 这个函数才能取得游戏创建的 Direct3DDevice, 而 CreateDevice() 是 IDirect3D9 接口的虚函数, 这一点我们阅读 D3D 的头文件 d3d9.h 就可以得知(见下面代码摘要), 实际上, d3d 系列的所有函数都是虚函数.</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008800">#define DECLARE_INTERFACE_(iface, baseiface) interface DECLSPEC_NOVTABLE iface : public baseiface</span>

<span style="color: #008800">#define STDMETHOD(method) virtual COM_DECLSPEC_NOTHROW HRESULT STDMETHODCALLTYPE method</span>
<span style="color: #008800">#define STDMETHOD_(type,method) virtual COM_DECLSPEC_NOTHROW type STDMETHODCALLTYPE method</span>

DECLARE_INTERFACE_(IDirect3D9, IUnknown) {
    <span style="color: #008800; font-style: italic">/*** IUnknown methods ***/</span>
    STDMETHOD(QueryInterface)(THIS_ REFIID riid, <span style="color: #00BB00; font-weight: bold">void</span><span style="color: #666666">**</span> ppvObj) PURE;
   ......
    <span style="color: #008800; font-style: italic">/*** IDirect3D9 methods ***/</span>
    STDMETHOD(RegisterSoftwareDevice)(THIS_ <span style="color: #00BB00; font-weight: bold">void</span><span style="color: #666666">*</span> pInitializeFunction) PURE;
   ......
};
</pre></div>


<p>游戏初始化时, 会通过 Direct3DCreate9() 创建一个 IDirect3D9 指针, 然后用这个 IDirect3D9 指针调用它的 CreateDevice() 函数;</p>
<p>此时, 如果我们创建一个子类继承 IDirect3D9 类, 然后在游戏初始化前 HOOK Direct3DCreate9() 函数, 在 Direct3DCreate9()  内部用我们刚创建的子类创建一个指针, 并把这个子类的指针返回给游戏;
根据 C++ 继承特性, 这个指针是子类的, 所以当游戏用这个指针调用 d3d 系列的函数时, 如果我们重写了父类的对应虚函数, 那么实际上它调用的就会是我们子类重写后的函数了.</p>
<p>因此, 我们想要 HOOK IDirect3D9::CreateDevice() 取 Direct3DDevice, 只需要在子类中重写 IDirect3D9 的 CreateDevice() 就可以了, 具体代码见上面分享, 个人推荐用劫持的方式, 相对安全一点.</p>
<hr />
<p>除了利用 C++ 继承特性外, 还有一种方法是利用 C++ 虚函数的特性直接 HOOK IDirect3D9 的虚表, 所以有必要先了解一下虚函数的机制: 当类中定义有虚函数时, 编译器会将该类中所有虚函数的地址保存在一张表中, 这张表被称为虚函数地址表(虚表), 同时编译器会在类中添加一个隐藏的数据成员, 即虚表指针, 它指向该类的虚表,  这个隐藏的数据成员在类的开始处, 即类的头 4 字节.</p>
<p>知道了上面这些, 那 HOOK IDirect3D9 的虚表也就不在话下了, 第一步仍然是 HOOK Direct3DCreate9() 取游戏创建的 IDirect3D9 指针, 有了这个指针, 就能从它的头 4 字节处取出虚表, 再找到 CreateDevice() 在虚表中的位置, 替换成我们自己的 CreateDevice(), 然后 OOXX . . .</p>
<p>参考代码:</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">class</span> <span style="color: #0000FF">Test</span> {
<span style="color: #AA22FF; font-weight: bold">public</span><span style="color: #666666">:</span>
    <span style="color: #AA22FF; font-weight: bold">virtual</span> <span style="color: #00BB00; font-weight: bold">void</span> Hello() {
        AfxMessageBox(<span style="color: #AA22FF; font-weight: bold">nullptr</span>);
    }
};

<span style="color: #00BB00; font-weight: bold">void</span> <span style="color: #AA22FF; font-weight: bold">__stdcall</span> <span style="color: #00A000">New_Hello</span>() {
    AfxMessageBox(TEXT(<span style="color: #BB4444">&quot;Hello&quot;</span>));
}

<span style="color: #00BB00; font-weight: bold">void</span> <span style="color: #00A000">BnClickedButton</span>() {
    Test<span style="color: #666666">*</span> pTest <span style="color: #666666">=</span> <span style="color: #AA22FF; font-weight: bold">new</span> Test;
    PVOID p <span style="color: #666666">=</span> ((PVOID<span style="color: #666666">*</span>)pTest)[<span style="color: #666666">0</span>]; <span style="color: #008800; font-style: italic">// 取虚表</span>
    DWORD dwOldPro;
    VirtualProtect(p, <span style="color: #666666">4</span>, PAGE_EXECUTE_READWRITE, <span style="color: #666666">&amp;</span>dwOldPro); <span style="color: #008800; font-style: italic">// 修改内存保护属性</span>
    ((PVOID<span style="color: #666666">*</span>)p)[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> New_Hello; <span style="color: #008800; font-style: italic">// 改函数表函数</span>
    VirtualProtect(p, <span style="color: #666666">4</span>, dwOldPro, <span style="color: #666666">&amp;</span>dwOldPro); <span style="color: #008800; font-style: italic">// 恢复内存保护属性</span>
    pTest<span style="color: #666666">-&gt;</span>Hello();
    <span style="color: #AA22FF; font-weight: bold">delete</span> pTest;
}
</pre></div>


<p>最后共享一份 d3d 虚函数的索引: <a href="http://yunpan.cn/cw3kuPtUp2xHu">http://yunpan.cn/cw3kuPtUp2xHu</a>  访问密码 bc7a</p>
<p class="subheader">Category: <a href="http://z351522453.github.com/blog/category/hei-ke-ji.html">黑科技</a>

</p>




</article>
    </div>
    <!-- End Main Content -->

    <!-- Sidebar -->
    <aside class="large-3 columns">
        <h5 class="sidebar-title">Site</h5>
        <ul class="side-nav">
            <li><a href="http://z351522453.github.com/blog/archives.html">Archives</a>
            <li><a href="http://z351522453.github.com/blog/tags.html">Tags</a>
        </ul>

		
        <h5 class="sidebar-title">Categories</h5>
        <ul class="side-nav">
            <li><a href="http://z351522453.github.com/blog/category/ban-ben-kong-zhi.html">版本控制</a></li>
            <li><a href="http://z351522453.github.com/blog/category/c11xin-te-xing.html">C++11新特性</a></li>
            <li><a href="http://z351522453.github.com/blog/category/cocos2dyou-xi-kai-fa.html">Cocos2d游戏开发</a></li>
            <li><a href="http://z351522453.github.com/blog/category/da-hua-she-ji-mo-shi.html">大话设计模式</a></li>
            <li><a href="http://z351522453.github.com/blog/category/da-shu-ju.html">大数据</a></li>
            <li><a href="http://z351522453.github.com/blog/category/dai-ma-da-quan.html">代碼大全</a></li>
            <li><a href="http://z351522453.github.com/blog/category/golang.html">Golang</a></li>
            <li><a href="http://z351522453.github.com/blog/category/hadoop.html">hadoop</a></li>
            <li><a href="http://z351522453.github.com/blog/category/hei-ke-ji.html">黑科技</a></li>
            <li><a href="http://z351522453.github.com/blog/category/jia-che-bao-dian.html">驾车宝典</a></li>
            <li><a href="http://z351522453.github.com/blog/category/jia-gou-shi-zhi-lu.html">架构师之路</a></li>
            <li><a href="http://z351522453.github.com/blog/category/ling-ji-chu-qt-ru-men.html">零基础 QT 入门</a></li>
            <li><a href="http://z351522453.github.com/blog/category/linux.html">Linux</a></li>
            <li><a href="http://z351522453.github.com/blog/category/luayou-xi-kai-fa.html">Lua游戏开发</a></li>
            <li><a href="http://z351522453.github.com/blog/category/pyqt-kai-fa.html">PyQt 开发</a></li>
            <li><a href="http://z351522453.github.com/blog/category/python-cong-ru-men-dao-fang-qi.html">Python 从入门到放弃</a></li>
            <li><a href="http://z351522453.github.com/blog/category/shen-ru-qian-chu-flask.html">深入浅出 Flask</a></li>
            <li><a href="http://z351522453.github.com/blog/category/shen-ru-qian-chu-mongodb.html">深入浅出 Mongodb</a></li>
            <li><a href="http://z351522453.github.com/blog/category/shen-ru-qian-chu-redis.html">深入浅出 Redis</a></li>
            <li><a href="http://z351522453.github.com/blog/category/za-xiang.html">杂项</a></li>
            <li><a href="http://z351522453.github.com/blog/category/zai-xue-java.html">再学 JAVA</a></li>
   
        </ul>

        <h5 class="sidebar-title">Links</h5>
        <ul class="side-nav">
            <li><a href="http://blog.csdn.net/u010850265">CSDN</a></li>
        </ul>
		
        <h5 class="sidebar-title">Social</h5>
        <ul class="side-nav">
            <li><a href="http://blog.csdn.net/u010850265">CSDN</a></li>
        </ul>

    </aside> <!-- End Sidebar -->

</div> <!-- End Main Content and Sidebar -->


<!-- Footer -->
<footer class="row">
    <div class="large-12 columns">
        <hr />
        <div class="row">
            <div class="large-6 columns">
              <!--                  <p>Small Cpp | 勿在浮沙筑高台, 练从难处练, 用从易处用. by martin</p> -->
            </div>
            </div>
    </div>
</footer>
</body>
</html>